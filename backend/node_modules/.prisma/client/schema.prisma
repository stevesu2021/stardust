generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

model User {
  id            String   @id @default(uuid())
  email         String?  @unique
  phone         String?  @unique
  password      String?
  nickname      String?
  avatar        String?
  birthYear     Int
  birthMonth    Int
  birthDay      Int
  birthHour     Int
  lunarDate     String?
  zodiacSign    String?
  fiveElements  String?
  gender        String?
  bio           String?
  wechatOpenId  String?  @unique // 微信OpenID
  wechatUnionId String?  @unique // 微信UnionID
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  prayers           Prayer[]
  confessions       Confession[]
  treeholes         Treehole[]
  sentMessages      Message[]          @relation("SentMessages")
  receivedMessages  Message[]          @relation("ReceivedMessages")
  matches           Match[]            @relation("UserMatches")
  matchedUsers      Match[]            @relation("MatchedUsers")
  palmReadings      PalmReading[]
  astrologyReadings AstrologyReading[]

  @@map("users")
}

model Prayer {
  id          String   @id @default(uuid())
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  content     String
  targetName  String?
  image       String?
  prayerCount Int      @default(1)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("prayers")
}

model Confession {
  id          String   @id @default(uuid())
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  targetName  String
  content     String
  isAnonymous Boolean  @default(true)
  isMatched   Boolean  @default(false)
  matchedWith String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("confessions")
}

model Treehole {
  id        String   @id @default(uuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  content   String
  image     String?
  likes     Int      @default(0)
  comments  Int      @default(0)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("treeholes")
}

model Message {
  id         String   @id @default(uuid())
  senderId   String
  sender     User     @relation("SentMessages", fields: [senderId], references: [id], onDelete: Cascade)
  receiverId String
  receiver   User     @relation("ReceivedMessages", fields: [receiverId], references: [id], onDelete: Cascade)
  content    String
  isRead     Boolean  @default(false)
  createdAt  DateTime @default(now())

  @@map("messages")
}

model Match {
  id          String   @id @default(uuid())
  userId      String
  user        User     @relation("UserMatches", fields: [userId], references: [id], onDelete: Cascade)
  matchedId   String
  matchedUser User     @relation("MatchedUsers", fields: [matchedId], references: [id], onDelete: Cascade)
  score       Float
  createdAt   DateTime @default(now())

  @@unique([userId, matchedId])
  @@map("matches")
}

model PalmReading {
  id         String   @id @default(uuid())
  userId     String
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  imageUrl   String   @db.LongText // MinIO 中存储的图片 URL 或 base64 数据
  lifeLine   String   @db.LongText
  wisdomLine String   @db.LongText
  loveLine   String   @db.LongText
  careerLine String   @db.LongText
  overall    String   @db.LongText
  createdAt  DateTime @default(now())

  @@map("palm_readings")
}

// 星盘解读记录表
model AstrologyReading {
  id     String @id @default(uuid())
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // 基础数据
  zodiacSign String // 西方星座：白羊座、金牛座等
  lunarDate  String // 农历日期：甲辰年正月初一

  // 八字四柱
  yearPillar  String // 年柱：甲辰
  monthPillar String // 月柱：丙寅
  dayPillar   String // 日柱：戊子
  hourPillar  String // 时柱：壬子

  // 五行统计 (JSON string)
  fiveElements String @db.LongText // {"wood":2,"fire":1,"earth":2,"metal":1,"water":2}

  // AI 解读结果
  zodiacInterpretation String @db.LongText // 星座解读
  baziInterpretation   String @db.LongText // 八字解读

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([userId]) // 每个用户只保留最新的一条记录
  @@map("astrology_readings")
}
