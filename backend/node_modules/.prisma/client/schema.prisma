generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

model User {
  id                String    @id @default(uuid())
  email             String?   @unique
  phone             String?   @unique
  password          String?
  nickname          String?
  anonymousNickname String? // 匿名昵称（用于树洞等场景）
  avatar            String? // 头像URL
  avatarType        String? // 头像类型: upload(用户上传) | ai_generated(AI生成)
  avatarUpdatedAt   DateTime? // 头像更新时间
  lastAiAvatarDate  DateTime? // 上次AI生成头像的日期（用于每日限制）
  birthYear         Int
  birthMonth        Int
  birthDay          Int
  birthHour         Int
  birthProvince     String    @default("山西") // 出生省份
  currentProvince   String    @default("北京") // 现居地省份
  lunarDate         String?
  zodiacSign        String?
  fiveElements      String?
  gender            String?
  bio               String?
  wechatOpenId      String?   @unique // 微信OpenID
  wechatUnionId     String?   @unique // 微信UnionID
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  // 保留旧的关系（兼容性）
  prayers           Prayer[]
  // 新的关系
  devoutPrayers     DevoutPrayer[]
  reunitePrayers    ReunitePrayer[]
  confessions       Confession[]
  treeholes         Treehole[]
  sentMessages      Message[]          @relation("SentMessages")
  receivedMessages  Message[]          @relation("ReceivedMessages")
  matches           Match[]            @relation("UserMatches")
  matchedUsers      Match[]            @relation("MatchedUsers")
  palmReadings      PalmReading[]
  astrologyReadings AstrologyReading[]
  mbtiResults       MbtiResult[]
  dailyFortunes     DailyFortune[]

  @@map("users")
}

model Prayer {
  id          String   @id @default(uuid())
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  content     String   @db.LongText
  targetName  String? // 旧字段，保留兼容
  image       String?
  prayerCount Int      @default(1)
  category    String? // 分类名称
  deities     String?  @db.LongText // 祈祷的神职（JSON 数组）
  isAnonymous Boolean  @default(false) // 是否匿名祈祷
  supports    Int      @default(0) // 支持数（点赞）
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("prayers")
}

// 虔诚祈祷表
model DevoutPrayer {
  id           String   @id @default(uuid())
  userId       String
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  content      String   @db.LongText // 祈祷内容
  category     String? // 分类ID（如 category_1, category_2...）
  categoryName String? // 分类名称（如"综合护佑 / 万能型"）
  deities      String?  @db.LongText // 祈祷的神职列表（JSON 数组）
  supports     Int      @default(0) // 支持数（点赞）
  isAnonymous  Boolean  @default(false) // 是否匿名祈祷
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@map("devout_prayers")
}

// 复合祈愿表
model ReunitePrayer {
  id          String   @id @default(uuid())
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  content     String   @db.LongText // 祈愿内容
  targetName  String? // 对方名字
  image       String? // 图片URL
  prayerCount Int      @default(1) // 祈祷次数
  isAnonymous Boolean  @default(false) // 是否匿名祈祷
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("reunite_prayers")
}

model Confession {
  id          String   @id @default(uuid())
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  targetName  String
  content     String
  isAnonymous Boolean  @default(true)
  isMatched   Boolean  @default(false)
  matchedWith String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("confessions")
}

model Treehole {
  id        String   @id @default(uuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  content   String
  image     String?
  likes     Int      @default(0)
  comments  Int      @default(0)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("treeholes")
}

model Message {
  id         String   @id @default(uuid())
  senderId   String
  sender     User     @relation("SentMessages", fields: [senderId], references: [id], onDelete: Cascade)
  receiverId String
  receiver   User     @relation("ReceivedMessages", fields: [receiverId], references: [id], onDelete: Cascade)
  content    String
  isRead     Boolean  @default(false)
  createdAt  DateTime @default(now())

  @@map("messages")
}

model Match {
  id          String   @id @default(uuid())
  userId      String
  user        User     @relation("UserMatches", fields: [userId], references: [id], onDelete: Cascade)
  matchedId   String
  matchedUser User     @relation("MatchedUsers", fields: [matchedId], references: [id], onDelete: Cascade)
  score       Float
  createdAt   DateTime @default(now())

  @@unique([userId, matchedId])
  @@map("matches")
}

model PalmReading {
  id         String   @id @default(uuid())
  userId     String
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  imageUrl   String   @db.LongText // MinIO 中存储的图片 URL 或 base64 数据
  lifeLine   String   @db.LongText
  wisdomLine String   @db.LongText
  loveLine   String   @db.LongText
  careerLine String   @db.LongText
  overall    String   @db.LongText
  createdAt  DateTime @default(now())

  @@map("palm_readings")
}

// 星盘解读记录表
model AstrologyReading {
  id     String @id @default(uuid())
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // 基础数据
  zodiacSign String // 西方星座：白羊座、金牛座等
  lunarDate  String // 农历日期：甲辰年正月初一

  // 八字四柱
  yearPillar  String // 年柱：甲辰
  monthPillar String // 月柱：丙寅
  dayPillar   String // 日柱：戊子
  hourPillar  String // 时柱：壬子

  // 五行统计 (JSON string)
  fiveElements String @db.LongText // {"wood":2,"fire":1,"earth":2,"metal":1,"water":2}

  // AI 解读结果
  zodiacInterpretation String @db.LongText // 星座解读
  baziInterpretation   String @db.LongText // 八字解读
  klineInterpretation  String @db.LongText // 人生K线解读

  // 每日AI解读次数限制
  dailyInterpretCount Int     @default(0) // 当日已使用次数
  lastInterpretDate   String? // 上次解读日期 (YYYY-MM-DD)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([userId]) // 每个用户只保留最新的一条记录
  @@map("astrology_readings")
}

// MBTI 测试结果表
model MbtiResult {
  id        String   @id @default(uuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  mbtiType  String // MBTI类型：INTJ, ENFP 等
  eScore    Int      @default(0) // E 得分
  iScore    Int      @default(0) // I 得分
  sScore    Int      @default(0) // S 得分
  nScore    Int      @default(0) // N 得分
  tScore    Int      @default(0) // T 得分
  fScore    Int      @default(0) // F 得分
  jScore    Int      @default(0) // J 得分
  pScore    Int      @default(0) // P 得分
  answers   String   @db.LongText // 用户答案（JSON 数组）
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([userId]) // 每个用户只保留最新的一条记录
  @@map("mbti_results")
}

// 今日运势表
model DailyFortune {
  id             String   @id @default(uuid())
  userId         String
  user           User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  fortuneDate    String // 运势日期 (YYYY-MM-DD)
  overallScore   Int // 总体得分 (0-100)
  summary        String // 简短摘要
  precautions    String?  @db.LongText // 注意事项
  career         String?  @db.LongText // 事业运势
  love           String?  @db.LongText // 爱情运势
  wealth         String?  @db.LongText // 财富运势
  health         String?  @db.LongText // 健康运势
  luckyColor     String? // 幸运颜色
  luckyNumber    Int? // 幸运数字
  luckyDirection String? // 幸运方位
  advice         String?  @db.LongText // 建议
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  @@unique([userId, fortuneDate]) // 每个用户每天只有一条运势记录
  @@map("daily_fortunes")
}

// 星座名人表
model FamousPerson {
  id          String   @id @default(uuid())
  name        String // 姓名
  nationality String // 国籍/时代
  birthDate   String // 出生日期 (YYYY-MM-DD，负数表示公元前)
  zodiacSign  String // 星座：白羊座、金牛座等
  category    String // 分类：科学、政治、商业、文学、艺术、体育等
  createdAt   DateTime @default(now())

  @@map("famous_people")
}

// 商品表
model Product {
  id         String   @id @default(uuid())
  title      String   @db.LongText // 商品标题
  productId  String // 1688商品ID
  productUrl String   @db.LongText // 商品链接
  imageUrl   String   @db.LongText // 图片地址
  price      Float // 商品价格
  platform   String // 平台（1688等）
  shopName   String // 店铺名称
  category   String // 所属分组（手串、吊坠等）
  tags       String? // 标签
  remark     String? // 备注
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@unique([productId, platform]) // 同一平台的商品ID唯一
  @@map("products")
}
