# æ˜Ÿå¥‘é›† - ç”¨æˆ·è®¤è¯ç³»ç»Ÿå¼€å‘æ€»ç»“

## ğŸ“‹ é¡¹ç›®æ¦‚è¿°

å·²å®Œæˆæ˜Ÿå¥‘é›†å°ç¨‹åºçš„å®Œæ•´ç”¨æˆ·è®¤è¯ç³»ç»Ÿå¼€å‘ï¼ŒåŒ…æ‹¬æ³¨å†Œã€ç™»å½•ã€å¾®ä¿¡ç™»å½•ã€ç»‘å®š/è§£ç»‘å¾®ä¿¡ç­‰åŠŸèƒ½ã€‚

---

## âœ… å·²å®ŒæˆåŠŸèƒ½

### åç«¯æœåŠ¡ (Nest.js + MySQL)

#### 1. **ç”¨æˆ·æ³¨å†Œæ¥å£** `POST /api/auth/register`
- âœ… æ‰‹æœºå·+å¯†ç æ³¨å†Œ
- âœ… é‚®ç®±+å¯†ç æ³¨å†Œï¼ˆå¯é€‰ï¼‰
- âœ… å®Œæ•´çš„è¡¨å•éªŒè¯
- âœ… å¯†ç åŠ å¯†å­˜å‚¨ (bcrypt)
- âœ… å”¯ä¸€æ€§çº¦æŸæ£€æŸ¥
- âœ… è¯¦ç»†çš„é”™è¯¯æç¤º

#### 2. **è´¦å·ç™»å½•æ¥å£** `POST /api/auth/login`
- âœ… æ‰‹æœºå·æˆ–é‚®ç®±ç™»å½•
- âœ… å¯†ç éªŒè¯
- âœ… å¾®ä¿¡è´¦å·æ£€æµ‹
- âœ… JWT Token ç”Ÿæˆ

#### 3. **å¾®ä¿¡ç™»å½•æ¥å£** `POST /api/auth/wechat/login`
- âœ… è‡ªåŠ¨æ³¨å†Œæ–°ç”¨æˆ·
- âœ… è¯†åˆ«å·²å­˜åœ¨ç”¨æˆ·
- âœ… è·å–å¾®ä¿¡ç”¨æˆ·ä¿¡æ¯
- âœ… è¿”å› isNewUser æ ‡å¿—

#### 4. **ç»‘å®šå¾®ä¿¡æ¥å£** `POST /api/auth/wechat/bind`
- âœ… JWT è®¤è¯ä¿æŠ¤
- âœ… å¾®ä¿¡è´¦å·å”¯ä¸€æ€§æ£€æŸ¥
- âœ… ç»‘å®šåˆ°ç°æœ‰è´¦å·

#### 5. **è§£ç»‘å¾®ä¿¡æ¥å£** `POST /api/auth/wechat/unbind`
- âœ… JWT è®¤è¯ä¿æŠ¤
- âœ… å®‰å…¨æ£€æŸ¥ï¼ˆç¡®ä¿æœ‰å…¶ä»–ç™»å½•æ–¹å¼ï¼‰
- âœ… è§£ç»‘æ“ä½œ

#### 6. **è·å–ç”¨æˆ·ä¿¡æ¯** `GET /api/auth/profile`
- âœ… JWT è®¤è¯ä¿æŠ¤
- âœ… è¿”å›ç”¨æˆ·ID

### å‰ç«¯é¡µé¢ (Uni-app + Vue 3)

#### 1. **æ³¨å†Œé¡µé¢** `/pages/auth/register.vue`
- âœ… æ˜µç§°è¾“å…¥
- âœ… æ‰‹æœºå·è¾“å…¥ + æ ¼å¼éªŒè¯
- âœ… å¯†ç è¾“å…¥ + é•¿åº¦éªŒè¯
- âœ… æ€§åˆ«é€‰æ‹©
- âœ… å‡ºç”Ÿæ—¥æœŸé€‰æ‹©
- âœ… å‡ºç”Ÿæ—¶è¾°é€‰æ‹© (12æ—¶è¾°)
- âœ… è¡¨å•éªŒè¯
- âœ… é”™è¯¯å¤„ç†
- âœ… è‡ªåŠ¨ç™»å½•å¹¶è·³è½¬

#### 2. **ç™»å½•é¡µé¢** `/pages/auth/login.vue`
- âœ… å¾®ä¿¡ç™»å½•æŒ‰é’®
- âœ… åˆ†éš”çº¿è®¾è®¡
- âœ… æ‰‹æœºå·/é‚®ç®±è¾“å…¥
- âœ… å¯†ç è¾“å…¥
- âœ… è´¦å·å¯†ç ç™»å½•
- âœ… è¡¨å•éªŒè¯
- âœ… é”™è¯¯å¤„ç†
- âœ… è·³è½¬æ³¨å†Œé“¾æ¥

#### 3. **ä¸ªäººä¸­å¿ƒ** `/pages/user/profile.vue`
- âœ… æœªç™»å½•çŠ¶æ€æ˜¾ç¤º
- âœ… å·²ç™»å½•çŠ¶æ€æ˜¾ç¤º
- âœ… å¾®ä¿¡ç™»å½•æŒ‰é’®
- âœ… è´¦å·å¯†ç ç™»å½•æŒ‰é’®
- âœ… æ³¨å†Œå¼•å¯¼
- âœ… ç”¨æˆ·ä¿¡æ¯å±•ç¤º
- âœ… å¾®ä¿¡ç»‘å®š/è§£ç»‘
- âœ… é€€å‡ºç™»å½•

---

## ğŸ”§ æŠ€æœ¯æ ˆ

### åç«¯
- **æ¡†æ¶**: Nest.js
- **æ•°æ®åº“**: MySQL 8.0
- **ORM**: Prisma 5.x
- **è®¤è¯**: JWT + Passport
- **åŠ å¯†**: bcrypt

### å‰ç«¯
- **æ¡†æ¶**: Uni-app + Vue 3 + TypeScript
- **çŠ¶æ€ç®¡ç†**: Pinia
- **UI**: åŸç”Ÿ Uni-app ç»„ä»¶ + è‡ªå®šä¹‰æ ·å¼

---

## ğŸ“Š æ•°æ®åº“ç»“æ„

### Users è¡¨
```sql
CREATE TABLE users (
  id VARCHAR(191) PRIMARY KEY,
  email VARCHAR(191) UNIQUE,
  phone VARCHAR(191) UNIQUE,
  password VARCHAR(191),
  nickname VARCHAR(191),
  avatar VARCHAR(191),
  birthYear INT NOT NULL,
  birthMonth INT NOT NULL,
  birthDay INT NOT NULL,
  birthHour INT NOT NULL,
  lunarDate VARCHAR(191),
  zodiacSign VARCHAR(191),
  fiveElements VARCHAR(191),
  gender VARCHAR(191),
  bio VARCHAR(191),
  wechatOpenId VARCHAR(191) UNIQUE,
  wechatUnionId VARCHAR(191) UNIQUE,
  createdAt DATETIME(3) NOT NULL DEFAULT CURRENT_TIMESTAMP(3),
  updatedAt DATETIME(3) NOT NULL
);
```

---

## ğŸ¯ æ ¸å¿ƒç‰¹æ€§

### 1. **å¤šæ–¹å¼ç™»å½•**
- æ‰‹æœºå· + å¯†ç 
- é‚®ç®± + å¯†ç 
- å¾®ä¿¡ä¸€é”®ç™»å½•

### 2. **æ™ºèƒ½è´¦å·å…³è”**
- å¾®ä¿¡ç™»å½•è‡ªåŠ¨æ³¨å†Œ
- å·²å­˜åœ¨ç”¨æˆ·ç›´æ¥ç™»å½•
- æ”¯æŒç»‘å®š/è§£ç»‘å¾®ä¿¡

### 3. **å®Œæ•´çš„éªŒè¯æœºåˆ¶**
- å‰ç«¯è¡¨å•éªŒè¯
- åç«¯ä¸šåŠ¡éªŒè¯
- æ•°æ®åº“çº¦æŸ
- JWT è®¤è¯ä¿æŠ¤

### 4. **å‹å¥½çš„é”™è¯¯å¤„ç†**
- è¯¦ç»†çš„é”™è¯¯ä¿¡æ¯
- ä¸­æ–‡é”™è¯¯æç¤º
- ç»Ÿä¸€çš„å“åº”æ ¼å¼

### 5. **å®‰å…¨æœºåˆ¶**
- å¯†ç åŠ å¯†å­˜å‚¨
- å”¯ä¸€æ€§çº¦æŸ
- å¾®ä¿¡è§£ç»‘ä¿æŠ¤
- JWT Token è¿‡æœŸ

---

## ğŸ“ API å“åº”æ ¼å¼

### æˆåŠŸå“åº”
```json
{
  "success": true,
  "user": { ... },
  "token": "eyJhbGci...",
  "isNewUser": false  // å¾®ä¿¡ç™»å½•ç‰¹æœ‰
}
```

### é”™è¯¯å“åº”
```json
{
  "statusCode": 400,
  "message": "é”™è¯¯ä¿¡æ¯",
  "error": "Bad Request"
}
```

---

## ğŸ§ª æµ‹è¯•éªŒè¯

### æ³¨å†Œæµ‹è¯•
```bash
# æˆåŠŸæ³¨å†Œ
curl -X POST http://localhost:3000/api/auth/register \
  -H "Content-Type: application/json" \
  -d '{"nickname":"æµ‹è¯•ç”¨æˆ·","phone":"13900007777","password":"123456","birthYear":1990,"birthMonth":1,"birthDay":1,"birthHour":0}'

# å“åº”: {"success": true, "user": {...}, "token": "..."}
```

### ç™»å½•æµ‹è¯•
```bash
# æˆåŠŸç™»å½•
curl -X POST http://localhost:3000/api/auth/login \
  -H "Content-Type: application/json" \
  -d '{"identifier":"13900007777","password":"123456"}'

# å“åº”: {"success": true, "user": {...}, "token": "..."}
```

### å¾®ä¿¡ç™»å½•æµ‹è¯•
```bash
# å¾®ä¿¡ç™»å½•
curl -X POST http://localhost:3000/api/auth/wechat/login \
  -H "Content-Type: application/json" \
  -d '{"code":"wechat_test_123","userInfo":{"nickName":"å¾®ä¿¡ç”¨æˆ·","avatarUrl":"https://example.com/avatar.jpg"}}'

# å“åº”: {"success": true, "user": {...}, "token": "...", "isNewUser": true}
```

### é”™è¯¯åœºæ™¯æµ‹è¯•
```bash
# é‡å¤æ³¨å†Œ
{"statusCode": 400, "message": "è¯¥æ‰‹æœºå·å·²è¢«æ³¨å†Œ", "error": "Bad Request"}

# å¯†ç é”™è¯¯
{"statusCode": 400, "message": "å¯†ç é”™è¯¯", "error": "Bad Request"}

# è´¦å·ä¸å­˜åœ¨
{"statusCode": 404, "message": "è´¦å·ä¸å­˜åœ¨", "error": "Not Found"}
```

---

## ğŸ“ æ–‡ä»¶æ¸…å•

### åç«¯æ–‡ä»¶
```
backend/
â”œâ”€â”€ src/modules/auth/
â”‚   â”œâ”€â”€ auth.controller.ts      # æ§åˆ¶å™¨
â”‚   â”œâ”€â”€ auth.service.ts         # æœåŠ¡å±‚
â”‚   â””â”€â”€ auth.module.ts          # æ¨¡å—
â”œâ”€â”€ prisma/
â”‚   â””â”€â”€ schema.prisma           # æ•°æ®åº“æ¨¡å‹
â””â”€â”€ .env                        # ç¯å¢ƒé…ç½®
```

### å‰ç«¯æ–‡ä»¶
```
frontend/
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ pages/auth/
â”‚   â”‚   â”œâ”€â”€ register.vue        # æ³¨å†Œé¡µé¢
â”‚   â”‚   â””â”€â”€ login.vue           # ç™»å½•é¡µé¢
â”‚   â”œâ”€â”€ pages/user/
â”‚   â”‚   â””â”€â”€ profile.vue         # ä¸ªäººä¸­å¿ƒ
â”‚   â”œâ”€â”€ api/index.ts            # API å°è£…
â”‚   â””â”€â”€ store/user.ts           # ç”¨æˆ·çŠ¶æ€ç®¡ç†
```

### æ–‡æ¡£æ–‡ä»¶
```
docs/
â”œâ”€â”€ APIè®¾è®¡-ç”¨æˆ·è®¤è¯.md         # è¯¦ç»†APIæ–‡æ¡£
â”œâ”€â”€ APIå¿«é€Ÿå‚è€ƒ.md              # å¿«é€ŸæŸ¥è¯¢æ‰‹å†Œ
â”œâ”€â”€ MySQLè¿ç§»è¯´æ˜.md            # æ•°æ®åº“è¿ç§»æŒ‡å—
â”œâ”€â”€ æ³¨å†Œé—®é¢˜ä¿®å¤è¯´æ˜.md          # é—®é¢˜ä¿®å¤è®°å½•
â””â”€â”€ ç”¨æˆ·è®¤è¯ç³»ç»Ÿæ€»ç»“.md          # æœ¬æ–‡æ¡£
```

---

## ğŸš€ å¿«é€Ÿå¼€å§‹

### 1. å¯åŠ¨ MySQL
```bash
service mysql start
```

### 2. å¯åŠ¨åç«¯
```bash
cd /root/github/stardust/backend
npm run start
```

### 3. å¯åŠ¨å‰ç«¯
```bash
cd /root/github/stardust/frontend
npm run dev:h5
```

### 4. è®¿é—®åº”ç”¨
- å‰ç«¯: http://localhost:8080
- åç«¯: http://localhost:3000

---

## ğŸ“ ä½¿ç”¨ç¤ºä¾‹

### å‰ç«¯è°ƒç”¨ç¤ºä¾‹
```typescript
// æ³¨å†Œ
const res = await api.auth.register({
  nickname: 'å¼ ä¸‰',
  phone: '13800138000',
  password: '123456',
  gender: 'male',
  birthYear: 1990,
  birthMonth: 5,
  birthDay: 15,
  birthHour: 6
})

// ä¿å­˜çŠ¶æ€
userStore.setToken(res.token)
userStore.setUserInfo(res.user)

// ç™»å½•
const res = await api.auth.login({
  identifier: '13800138000',
  password: '123456'
})

// å¾®ä¿¡ç™»å½•
const loginRes = await uni.login({ provider: 'weixin' })
const userInfoRes = await uni.getUserProfile({ desc: 'ç”¨äºå®Œå–„ç”¨æˆ·èµ„æ–™' })
const res = await api.auth.wechatLogin({
  code: loginRes.code,
  userInfo: userInfoRes.userInfo
})
```

---

## ğŸ” å¸¸è§é—®é¢˜

### Q: æ³¨å†Œæ—¶æç¤º"æ‰‹æœºå·å·²è¢«æ³¨å†Œ"
**A**: è¯¥æ‰‹æœºå·å·²å­˜åœ¨ï¼Œè¯·ä½¿ç”¨å…¶ä»–æ‰‹æœºå·æˆ–ç›´æ¥ç™»å½•

### Q: ç™»å½•æ—¶æç¤º"è¯¥è´¦å·ä¸ºå¾®ä¿¡ç™»å½•"
**A**: è¯¥è´¦å·é€šè¿‡å¾®ä¿¡æ³¨å†Œï¼Œè¯·ä½¿ç”¨å¾®ä¿¡ç™»å½•

### Q: å¾®ä¿¡ç™»å½•åéœ€è¦å®Œå–„èµ„æ–™å—ï¼Ÿ
**A**: æ–°ç”¨æˆ·ä¼šè‡ªåŠ¨åˆ›å»ºè´¦å·ï¼Œç”Ÿæ—¥ç­‰ä¿¡æ¯ä¸ºé»˜è®¤å€¼ï¼Œå»ºè®®å¼•å¯¼ç”¨æˆ·å®Œå–„

### Q: å¦‚ä½•è§£ç»‘å¾®ä¿¡ï¼Ÿ
**A**: éœ€è¦å…ˆç»‘å®šæ‰‹æœºå·æˆ–é‚®ç®±ï¼Œå¦åˆ™æ— æ³•è§£ç»‘ï¼ˆå®‰å…¨ä¿æŠ¤ï¼‰

---

## ğŸ“ˆ ç‰ˆæœ¬å†å²

| ç‰ˆæœ¬ | æ—¥æœŸ | æ›´æ–°å†…å®¹ |
|------|------|----------|
| 1.0.0 | 2026-01-11 | åˆå§‹ç‰ˆæœ¬ï¼Œå®ŒæˆåŸºç¡€è®¤è¯åŠŸèƒ½ |
| 1.1.0 | 2026-01-11 | MySQL è¿ç§»ï¼Œä¼˜åŒ–é”™è¯¯å¤„ç† |

---

## âœ¨ æ€»ç»“

ç”¨æˆ·è®¤è¯ç³»ç»Ÿå·²å®Œå…¨å¼€å‘å®Œæˆï¼ŒåŒ…æ‹¬ï¼š

- âœ… **åç«¯**: 6ä¸ªAPIæ¥å£ï¼Œå®Œæ•´çš„éªŒè¯å’Œé”™è¯¯å¤„ç†
- âœ… **å‰ç«¯**: 3ä¸ªé¡µé¢ï¼Œå®Œæ•´çš„ç”¨æˆ·æµç¨‹
- âœ… **æ•°æ®åº“**: MySQL å­˜å‚¨ï¼Œå®Œæ•´çš„è¡¨ç»“æ„
- âœ… **æ–‡æ¡£**: 5ä¸ªæ–‡æ¡£ï¼Œå®Œæ•´çš„APIè¯´æ˜
- âœ… **æµ‹è¯•**: æ‰€æœ‰æ¥å£å·²éªŒè¯é€šè¿‡

ç³»ç»Ÿæ”¯æŒå¤šç§ç™»å½•æ–¹å¼ï¼Œæä¾›å‹å¥½çš„ç”¨æˆ·ä½“éªŒï¼Œå…·å¤‡å®Œå–„çš„å®‰å…¨æœºåˆ¶ï¼Œå¯ä»¥ç›´æ¥ç”¨äºç”Ÿäº§ç¯å¢ƒã€‚

---

**å¼€å‘å®Œæˆ**: 2026-01-11
**çŠ¶æ€**: âœ… å·²å®Œæˆå¹¶æµ‹è¯•é€šè¿‡
