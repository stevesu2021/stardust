# 星契集 - 微信登录功能说明

## 📋 功能概述

微信登录功能为用户提供了一键登录体验，无需记忆账号密码，提升用户注册和登录的便捷性。

## 🔧 技术实现

### 1. 数据库变更

在 `User` 模型中新增字段：
```prisma
wechatOpenId  String?   @unique  // 微信OpenID
wechatUnionId String?   @unique  // 微信UnionID
password      String?            // 改为可选，支持无密码登录
```

### 2. 后端API

#### 微信登录/注册
```http
POST /api/auth/wechat/login
Content-Type: application/json

{
  "code": "微信小程序登录code",
  "userInfo": {
    "nickName": "用户昵称",
    "avatarUrl": "头像URL"
  }
}

响应：
{
  "user": { ... },
  "token": "JWT令牌",
  "isNewUser": true/false
}
```

#### 绑定微信账号
```http
POST /api/auth/wechat/bind
Authorization: Bearer <token>
Content-Type: application/json

{
  "code": "微信登录code"
}

响应：
{
  "success": true
}
```

### 3. 前端实现

#### 登录流程
1. 用户点击"微信登录"按钮
2. 调用 `uni.login()` 获取微信登录code
3. 调用 `uni.getUserProfile()` 获取用户信息
4. 发送请求到后端 `/api/auth/wechat/login`
5. 保存token和用户信息
6. 新用户引导至个人资料页完善生日信息

#### 核心代码
```typescript
async function handleWechatLogin() {
  // 获取微信登录code
  const loginRes = await uni.login({ provider: 'weixin' })

  // 获取用户信息
  const userInfoRes = await uni.getUserProfile({ desc: '用于完善用户资料' })

  // 调用微信登录API
  const res = await api.auth.wechatLogin({
    code: loginRes.code,
    userInfo: userInfoRes.userInfo
  })

  // 保存登录状态
  userStore.setToken(res.token)
  userStore.setUserInfo(res.user)

  // 新用户引导
  if (res.isNewUser) {
    uni.navigateTo({ url: '/pages/user/profile' })
  }
}
```

## 🎯 用户体验流程

### 新用户
```
点击微信登录 → 授权用户信息 → 自动注册 → 引导完善生日 → 进入首页
```

### 已有账号的用户
```
点击微信登录 → 授权用户信息 → 自动登录 → 进入首页
```

### 绑定微信（已有账号用户）
```
登录账号 → 个人中心 → 绑定微信 → 授权 → 绑定成功
```

## 🔒 安全考虑

1. **微信授权**: 需要用户明确授权才能获取信息
2. **数据保护**: 微信OpenID/UnionID加密存储
3. **Token机制**: 使用JWT进行身份验证
4. **绑定验证**: 防止微信账号重复绑定

## 📱 平台支持

- ✅ 微信小程序
- ✅ App端（支持微信登录的平台）
- ⏳ H5端（需配置微信JS-SDK）

## 🚀 配置要求

### 微信小程序配置
1. 在微信公众平台申请AppID和AppSecret
2. 配置服务器域名白名单
3. 开启微信登录权限

### 后端环境变量（可选）
```env
WECHAT_APPID=你的小程序AppID
WECHAT_SECRET=你的小程序AppSecret
```

## 📝 待完善功能

- [ ] 真实微信API集成（替换模拟数据）
- [ ] 微信UnionID跨平台统一
- [ ] 微信支付集成
- [ ] 微信分享功能
- [ ] 微信订阅消息推送

## 🔍 调试说明

### 开发环境
由于没有真实微信环境，当前使用模拟数据：
- `openid`: `mock_openid_${code}`
- `unionid`: `mock_unionid_${code}`

### 生产环境
需要替换 `auth.service.ts` 中的模拟代码为真实微信API调用：
```typescript
// 替换此部分
const wechatResult: WeChatAuthResult = {
  openid: `mock_openid_${code}`,
  unionid: `mock_unionid_${code}`,
  session_key: 'mock_session_key'
};

// 为真实API调用
const wechatResult = await this.code2Session(code);
```

## 📊 数据统计建议

建议追踪以下指标：
- 微信登录使用率
- 新用户注册转化率
- 微信登录成功率
- 用户绑定率

---

**最后更新**: 2026-01-11
**版本**: 1.0.0