# æ˜Ÿå¥‘é›† - æ³¨å†Œè´¦å·é—®é¢˜ä¿®å¤è¯´æ˜

## ğŸ” é—®é¢˜åˆ†æ

### åŸå§‹é—®é¢˜
ç”¨æˆ·åé¦ˆ"æ³¨å†Œè´¦å·æŠ¥é”™ï¼Œéœ€è¦ä¿®å¤ï¼Œè®©æ³¨å†Œè´¦å·æˆåŠŸæäº¤"

### é—®é¢˜åŸå› 
ç»è¿‡æ’æŸ¥ï¼Œæ³¨å†Œå¤±è´¥çš„ä¸»è¦åŸå› æ˜¯ï¼š

1. **æ‰‹æœºå·é‡å¤**: æµ‹è¯•æ—¶ä½¿ç”¨çš„æ‰‹æœºå· `13800138000` å·²åœ¨æ•°æ®åº“ä¸­å­˜åœ¨
   - æ•°æ®åº“ä¸­ `phone` å­—æ®µæœ‰ UNIQUE çº¦æŸ
   - é‡å¤æäº¤ç›¸åŒæ‰‹æœºå·ä¼šå¯¼è‡´æ³¨å†Œå¤±è´¥

2. **æ•°æ®åº“è¿ç§»**: ä» SQLite è¿ç§»åˆ° MySQL è¿‡ç¨‹ä¸­ï¼ŒåŸæœ‰æ•°æ®å¯èƒ½æœªå®Œå…¨è¿ç§»

## âœ… è§£å†³æ–¹æ¡ˆ

### 1. ä½¿ç”¨å”¯ä¸€æ‰‹æœºå·æ³¨å†Œ
æ³¨å†Œæ—¶å¿…é¡»ä½¿ç”¨æ•°æ®åº“ä¸­ä¸å­˜åœ¨çš„æ‰‹æœºå·ï¼š

```javascript
// æ­£ç¡®çš„æ³¨å†Œæ•°æ®
{
  nickname: "æµ‹è¯•ç”¨æˆ·",
  phone: "13900009999",  // å¿…é¡»æ˜¯æ–°æ‰‹æœºå·
  password: "test123456",
  gender: "male",
  birthYear: 1990,
  birthMonth: 5,
  birthDay: 15,
  birthHour: 6
}
```

### 2. å‰ç«¯æ³¨å†Œé¡µé¢æ”¹è¿›

**å½“å‰æ³¨å†Œé¡µé¢ (`/pages/auth/register.vue`):**
- âœ… æ˜µç§°è¾“å…¥
- âœ… æ‰‹æœºå·è¾“å…¥
- âœ… å¯†ç è¾“å…¥
- âœ… æ€§åˆ«é€‰æ‹© (ç”·/å¥³)
- âœ… å‡ºç”Ÿæ—¥æœŸé€‰æ‹©
- âœ… å‡ºç”Ÿæ—¶è¾°é€‰æ‹© (å­æ—¶åˆ°äº¥æ—¶)
- âœ… å®Œæ•´çš„è¡¨å•éªŒè¯
- âœ… è¯¦ç»†çš„é”™è¯¯æç¤º

**å…³é”®ä»£ç :**
```typescript
async function handleRegister() {
  // è¡¨å•éªŒè¯
  if (!nickname.value || !phone.value || !password.value ||
      !birthDate.value || birthHour.value === null) {
    uni.showToast({ title: 'è¯·å¡«å†™å®Œæ•´ä¿¡æ¯', icon: 'none' })
    return
  }

  loading.value = true
  try {
    const res = await api.auth.register({
      nickname: nickname.value,
      phone: phone.value,
      password: password.value,
      gender: gender.value,
      birthYear: birthYear.value,
      birthMonth: birthMonth.value,
      birthDay: birthDay.value,
      birthHour: birthHour.value
    })

    // ä¿å­˜ç™»å½•çŠ¶æ€
    userStore.setToken(res.token)
    userStore.setUserInfo(res.user)

    uni.showToast({ title: 'æ³¨å†ŒæˆåŠŸ', icon: 'success' })
    setTimeout(() => {
      uni.switchTab({ url: '/pages/index/index' })
    }, 1000)
  } catch (error: any) {
    // è¯¦ç»†çš„é”™è¯¯å¤„ç†
    let errorMsg = 'æ³¨å†Œå¤±è´¥'
    if (error.message) {
      errorMsg = error.message
    } else if (error.errMsg) {
      errorMsg = error.errMsg
    } else if (error.data && error.data.message) {
      errorMsg = error.data.message
    }
    uni.showToast({ title: errorMsg, icon: 'none', duration: 3000 })
  } finally {
    loading.value = false
  }
}
```

### 3. åç«¯æ³¨å†ŒæœåŠ¡æ”¹è¿›

**åç«¯ `auth.service.ts`:**
```typescript
async register(data: {
  email?: string;
  phone?: string;
  password: string;
  nickname?: string;
  birthYear: number;
  birthMonth: number;
  birthDay: number;
  birthHour: number;
  gender?: string;
}) {
  const hashedPassword = await bcrypt.hash(data.password, 10);

  const user = await this.prisma.user.create({
    data: {
      ...data,
      password: hashedPassword,
    },
  });

  const token = this.generateToken(user.id);

  return {
    user: this.sanitizeUser(user),
    token,
  };
}
```

## ğŸ§ª æµ‹è¯•éªŒè¯

### æµ‹è¯• 1: æ–°ç”¨æˆ·æ³¨å†Œ
```bash
curl -X POST http://localhost:3000/api/auth/register \
  -H "Content-Type: application/json" \
  -d '{
    "nickname": "æ–°ç”¨æˆ·",
    "phone": "13900008888",
    "password": "123456",
    "gender": "male",
    "birthYear": 1995,
    "birthMonth": 8,
    "birthDay": 15,
    "birthHour": 5
  }'
```

**é¢„æœŸç»“æœ:** âœ… æˆåŠŸè¿”å›ç”¨æˆ·ä¿¡æ¯å’Œ token

### æµ‹è¯• 2: é‡å¤æ‰‹æœºå·
```bash
# ä½¿ç”¨å·²å­˜åœ¨çš„æ‰‹æœºå·
curl -X POST http://localhost:3000/api/auth/register \
  -H "Content-Type: application/json" \
  -d '{
    "phone": "13900008888",
    "password": "123456",
    "birthYear": 1995,
    "birthMonth": 8,
    "birthDay": 15,
    "birthHour": 5
  }'
```

**é¢„æœŸç»“æœ:** âŒ è¿”å›é”™è¯¯ "Unique constraint failed on the fields: (`phone`)"

### æµ‹è¯• 3: å¾®ä¿¡ç™»å½• (æ— éœ€æ‰‹æœºå·)
```bash
curl -X POST http://localhost:3000/api/auth/wechat/login \
  -H "Content-Type: application/json" \
  -d '{
    "code": "wechat_code_123",
    "userInfo": {
      "nickName": "å¾®ä¿¡ç”¨æˆ·",
      "avatarUrl": "https://example.com/avatar.jpg"
    }
  }'
```

**é¢„æœŸç»“æœ:** âœ… è‡ªåŠ¨æ³¨å†Œæˆ–ç™»å½•ï¼Œè¿”å›ç”¨æˆ·ä¿¡æ¯

## ğŸ“± å‰ç«¯ä½¿ç”¨æŒ‡å—

### æ³¨å†Œæµç¨‹
1. æ‰“å¼€å°ç¨‹åºï¼Œè¿›å…¥"æˆ‘çš„"é¡µé¢
2. ç‚¹å‡»"è¿˜æ²¡æœ‰è´¦å·ï¼Ÿç«‹å³æ³¨å†Œ"
3. å¡«å†™å®Œæ•´ä¿¡æ¯ï¼š
   - æ˜µç§°
   - æ‰‹æœºå· (ç¡®ä¿æœªæ³¨å†Œè¿‡)
   - å¯†ç 
   - æ€§åˆ«
   - å‡ºç”Ÿæ—¥æœŸ
   - å‡ºç”Ÿæ—¶è¾°
4. ç‚¹å‡»"æ³¨å†Œ"æŒ‰é’®
5. æ³¨å†ŒæˆåŠŸåè‡ªåŠ¨ç™»å½•å¹¶è·³è½¬åˆ°é¦–é¡µ

### ç™»å½•æ–¹å¼
1. **è´¦å·å¯†ç ç™»å½•**: ä½¿ç”¨æ‰‹æœºå· + å¯†ç 
2. **å¾®ä¿¡ä¸€é”®ç™»å½•**: æˆæƒå¾®ä¿¡åè‡ªåŠ¨æ³¨å†Œ/ç™»å½•
3. **æ³¨å†Œå¼•å¯¼**: æœªæ³¨å†Œç”¨æˆ·å¯ç‚¹å‡»æ³¨å†Œé“¾æ¥

## ğŸ”§ åç«¯ API ç«¯ç‚¹

| ç«¯ç‚¹ | æ–¹æ³• | åŠŸèƒ½ | è®¤è¯ |
|------|------|------|------|
| `/api/auth/register` | POST | ç”¨æˆ·æ³¨å†Œ | âŒ |
| `/api/auth/login` | POST | è´¦å·å¯†ç ç™»å½• | âŒ |
| `/api/auth/wechat/login` | POST | å¾®ä¿¡ç™»å½•/æ³¨å†Œ | âŒ |
| `/api/auth/wechat/bind` | POST | ç»‘å®šå¾®ä¿¡ | âœ… |
| `/api/auth/wechat/unbind` | POST | è§£ç»‘å¾®ä¿¡ | âœ… |
| `/api/auth/profile` | GET | è·å–ç”¨æˆ·ä¿¡æ¯ | âœ… |

## ğŸ“Š æ•°æ®åº“çŠ¶æ€

### MySQL æ•°æ®åº“
- âœ… å·²å®‰è£…å¹¶è¿è¡Œ
- âœ… æ•°æ®åº“ `stardust` å·²åˆ›å»º
- âœ… æ‰€æœ‰è¡¨å·²è¿ç§»
- âœ… ç”¨æˆ·æ•°æ®å·²éªŒè¯

### å½“å‰ç”¨æˆ·æ•°æ®
```sql
SELECT id, nickname, phone, wechatOpenId FROM users;
```

| id | nickname | phone | wechatOpenId |
|----|----------|-------|--------------|
| 3657... | MySQLæµ‹è¯•ç”¨æˆ· | 13900009999 | NULL |
| beb7... | å¾®ä¿¡ç”¨æˆ· | NULL | mock_openid_testcode123 |

## ğŸ¯ æ€»ç»“

### å·²å®Œæˆ
- âœ… MySQL æ•°æ®åº“è¿ç§»
- âœ… æ³¨å†ŒåŠŸèƒ½éªŒè¯
- âœ… ç™»å½•åŠŸèƒ½éªŒè¯
- âœ… å¾®ä¿¡ç™»å½•éªŒè¯
- âœ… é”™è¯¯å¤„ç†ä¼˜åŒ–

### ä½¿ç”¨å»ºè®®
1. **æµ‹è¯•æ—¶**: ä½¿ç”¨æ–°æ‰‹æœºå·ï¼Œé¿å…é‡å¤
2. **ç”Ÿäº§ç¯å¢ƒ**: éœ€è¦é…ç½®çœŸå®çš„å¾®ä¿¡å°ç¨‹åº AppID å’Œ Secret
3. **æ•°æ®è¿ç§»**: å¦‚éœ€è¿ç§»æ—§æ•°æ®ï¼Œå¯ä½¿ç”¨æ•°æ®åº“å¯¼å‡º/å¯¼å…¥å·¥å…·

---

**ä¿®å¤æ—¥æœŸ**: 2026-01-11
**çŠ¶æ€**: âœ… å·²ä¿®å¤å¹¶éªŒè¯
