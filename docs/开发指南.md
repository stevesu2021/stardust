# Stardust 开发指南

## 快速开始

### 1. 克隆项目

```bash
git clone <repository-url>
cd stardust
```

### 2. 安装依赖

```bash
# 安装所有依赖
npm run install:all

# 或分别安装
cd backend && npm install
cd frontend && npm install
```

### 3. 配置环境变量

```bash
# 复制环境变量模板
cp backend/.env.example backend/.env

# 编辑环境变量
vim backend/.env
```

环境变量说明：
- `DATABASE_URL`: PostgreSQL 数据库连接字符串
- `JWT_SECRET`: JWT 密钥（生产环境请修改）
- `JWT_EXPIRATION`: JWT 过期时间
- `PORT`: 后端服务端口

### 4. 初始化数据库

```bash
cd backend

# 生成 Prisma Client
npm run prisma:generate

# 运行数据库迁移
npm run prisma:migrate

# 可选：打开 Prisma Studio 管理数据库
npm run prisma:studio
```

### 5. 启动开发服务器

```bash
# 同时启动前后端
npm run dev

# 或分别启动
npm run dev:backend  # 后端运行在 http://localhost:3000
npm run dev:frontend # 前端运行在 http://localhost:8080
```

## 项目结构

### 后端结构

```
backend/
├── src/
│   ├── common/              # 公共模块
│   │   ├── prisma/          # Prisma 数据库配置
│   │   │   ├── prisma.service.ts
│   │   │   └── prisma.module.ts
│   │   ├── guards/          # 守卫
│   │   │   └── jwt-auth.guard.ts
│   │   └── utils/           # 工具函数
│   │       └── astrology.utils.ts
│   ├── modules/             # 业务模块
│   │   ├── auth/            # 认证模块
│   │   │   ├── auth.service.ts
│   │   │   ├── auth.controller.ts
│   │   │   └── auth.module.ts
│   │   ├── user/            # 用户模块
│   │   ├── astrology/       # 星座模块
│   │   ├── prayer/          # 祈愿模块
│   │   ├── confession/      # 表白模块
│   │   ├── treehole/        # 树洞模块
│   │   └── dating/          # 交友模块
│   ├── app.module.ts        # 应用模块
│   └── main.ts              # 入口文件
├── prisma/
│   └── schema.prisma       # 数据库模型
├── tsconfig.json            # TypeScript 配置
├── nest-cli.json            # Nest CLI 配置
└── package.json
```

### 前端结构

```
frontend/
├── src/
│   ├── pages/               # 页面
│   │   ├── index/           # 首页
│   │   ├── auth/            # 认证页面
│   │   ├── astrology/       # 星座页面
│   │   ├── prayer/          # 祈愿页面
│   │   ├── confession/      # 表白页面
│   │   ├── treehole/        # 树洞页面
│   │   ├── dating/          # 交友页面
│   │   └── user/            # 用户页面
│   ├── api/                 # API 接口
│   │   └── index.ts
│   ├── store/               # 状态管理
│   │   └── user.ts
│   ├── App.vue              # 根组件
│   └── main.ts              # 入口文件
├── static/                  # 静态资源
├── pages.json               # 页面配置
├── manifest.json            # 应用配置
├── vite.config.ts           # Vite 配置
└── package.json
```

## 开发规范

### 后端开发规范

1. **模块化开发**：
   - 每个功能模块包含 service、controller、module
   - 使用依赖注入管理模块间依赖

2. **代码风格**：
   - 使用 TypeScript 类型注解
   - 遵循 Nest.js 官方规范
   - 使用装饰器简化代码

3. **错误处理**：
   - 使用 Nest.js 内置异常类
   - 统一错误响应格式

4. **数据库操作**：
   - 使用 Prisma ORM
   - 使用事务处理复杂操作
   - 注意数据库索引优化

### 前端开发规范

1. **组件开发**：
   - 使用 Vue 3 组合式 API
   - 组件职责单一
   - 合理使用 props 和 emits

2. **状态管理**：
   - 使用 Pinia 管理全局状态
   - 本地状态使用 ref/reactive
   - 持久化重要状态

3. **API 调用**：
   - 统一使用封装的 request 函数
   - 错误处理统一处理
   - 合理使用 loading 状态

4. **样式规范**：
   - 使用 SCSS
   - 使用 rpx 单位适配不同屏幕
   - 统一设计规范

## 常用命令

### 后端命令

```bash
cd backend

# 开发模式
npm run start:dev

# 生产模式
npm run build
npm run start:prod

# 测试
npm run test
npm run test:cov

# Prisma
npm run prisma:generate  # 生成 Prisma Client
npm run prisma:migrate   # 运行数据库迁移
npm run prisma:studio    # 打开数据库管理界面
```

### 前端命令

```bash
cd frontend

# 开发模式
npm run dev:h5           # H5 开发
npm run dev:mp-weixin    # 微信小程序开发
npm run dev:mp-toutiao   # 抖音小程序开发
npm run dev:app          # App 开发

# 构建
npm run build:h5         # 构建 H5
npm run build:mp-weixin  # 构建微信小程序
npm run build:mp-toutiao # 构建抖音小程序
npm run build:app        # 构建 App
```

## 调试技巧

### 后端调试

1. **使用 VS Code 调试**：
   - 配置 `.vscode/launch.json`
   - 设置断点
   - 启动调试

2. **日志调试**：
   - 使用 `console.log` 输出日志
   - 使用 Nest.js Logger

3. **数据库调试**：
   - 使用 Prisma Studio 查看数据
   - 查看生成的 SQL

### 前端调试

1. **浏览器调试**：
   - 使用 Chrome DevTools
   - Vue DevTools 扩展

2. **小程序调试**：
   - 使用微信开发者工具
   - 使用抖音开发者工具

3. **App 调试**：
   - 使用 HBuilderX 真机调试
   - 使用 vconsole

## 部署指南

### 后端部署

1. **构建项目**：
```bash
cd backend
npm run build
```

2. **使用 Docker 部署**：
```bash
# 构建 Docker 镜像
docker build -t stardust-backend .

# 运行容器
docker run -p 3000:3000 --env-file .env stardust-backend
```

3. **使用 PM2 部署**：
```bash
# 安装 PM2
npm install -g pm2

# 启动应用
pm2 start dist/main.js --name stardust

# 查看日志
pm2 logs stardust

# 重启应用
pm2 restart stardust
```

### 前端部署

1. **H5 部署**：
```bash
cd frontend
npm run build:h5
# 将 dist 目录部署到 Nginx
```

2. **小程序部署**：
```bash
# 使用 HBuilderX 打包
# 上传到各平台开发者工具
# 提交审核
```

3. **App 部署**：
```bash
# 使用 HBuilderX 打包
# 生成 APK/IPA
# 发布到应用商店
```

## 常见问题

### 后端问题

1. **数据库连接失败**：
   - 检查 DATABASE_URL 是否正确
   - 检查数据库服务是否启动
   - 检查防火墙设置

2. **Prisma 迁移失败**：
   - 检查 schema.prisma 语法
   - 删除数据库重新创建
   - 使用 `prisma migrate reset`

3. **JWT 认证失败**：
   - 检查 JWT_SECRET 是否一致
   - 检查 token 是否过期
   - 检查 token 格式

### 前端问题

1. **API 请求失败**：
   - 检查后端服务是否启动
   - 检查代理配置
   - 检查网络连接

2. **页面跳转失败**：
   - 检查 pages.json 配置
   - 检查路径是否正确
   - 检查 tabBar 配置

3. **样式显示异常**：
   - 检查 rpx 单位使用
   - 检查样式作用域
   - 检查 CSS 兼容性

## 性能优化

### 后端优化

1. **数据库优化**：
   - 添加合适的索引
   - 使用连接池
   - 优化查询语句

2. **缓存优化**：
   - 使用 Redis 缓存热点数据
   - 实现查询结果缓存
   - 使用 CDN 加速静态资源

3. **代码优化**：
   - 使用异步操作
   - 避免内存泄漏
   - 优化算法复杂度

### 前端优化

1. **资源优化**：
   - 压缩图片
   - 懒加载组件
   - 使用 CDN

2. **渲染优化**：
   - 减少不必要的重渲染
   - 使用虚拟列表
   - 优化组件结构

3. **网络优化**：
   - 减少请求次数
   - 使用请求缓存
   - 启用 Gzip 压缩

## 贡献指南

1. Fork 项目
2. 创建特性分支 (`git checkout -b feature/AmazingFeature`)
3. 提交更改 (`git commit -m 'Add some AmazingFeature'`)
4. 推送到分支 (`git push origin feature/AmazingFeature`)
5. 开启 Pull Request

## 许可证

MIT License