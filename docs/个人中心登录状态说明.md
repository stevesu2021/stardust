# 星契集 - 个人中心登录状态功能说明

## 🎯 功能概述

个人中心页面现在支持智能登录状态判断，根据用户是否登录显示不同的界面和功能。

## 📱 界面展示

### 未登录状态
```
┌─────────────────────────────┐
│                             │
│   👋                        │
│                             │
│   欢迎来到星契集             │
│   登录后享受更多个性化服务    │
│                             │
│   💬 微信一键登录            │
│                             │
│   ───────── 或 ─────────    │
│                             │
│   [ 账号密码登录 ]           │
│                             │
│   还没有账号？立即注册        │
└─────────────────────────────┘
```

### 已登录状态
```
┌─────────────────────────────┐
│                             │
│   [头像]                    │
│   用户昵称                  │
│   💬 已绑定微信              │
│                             │
│   ── 个人信息 ──            │
│   农历生日: 未计算           │
│   星座: 未计算               │
│   五行: 未计算               │
│   性别: 未设置               │
│   简介: 未设置               │
│                             │
│   [ 计算星盘 ]               │
│   [ 编辑资料 ]               │
│   [ 绑定微信账号 ]           │
│   [ 退出登录 ]               │
└─────────────────────────────┘
```

## 🔧 技术实现

### 1. 登录状态判断
```typescript
const isLoggedin = computed(() => {
  return !!userStore.token && !!userStore.userInfo
})
```

### 2. 条件渲染
```vue
<!-- 未登录 -->
<view v-if="!isLoggedin" class="login-required">
  <!-- 微信登录按钮 -->
  <!-- 传统登录按钮 -->
  <!-- 注册引导 -->
</view>

<!-- 已登录 -->
<view v-else class="logged-in">
  <!-- 用户信息 -->
  <!-- 功能按钮 -->
</view>
```

### 3. 微信登录流程
```typescript
async function handleWechatLogin() {
  // 1. 获取微信code
  const loginRes = await uni.login({ provider: 'weixin' })

  // 2. 获取用户信息
  const userInfoRes = await uni.getUserProfile({ desc: '用于完善用户资料' })

  // 3. 调用微信登录API
  const res = await api.auth.wechatLogin({
    code: loginRes.code,
    userInfo: userInfoRes.userInfo
  })

  // 4. 保存状态
  userStore.setToken(res.token)
  userStore.setUserInfo(res.user)

  // 5. 新用户引导
  if (res.isNewUser) {
    uni.navigateTo({ url: '/pages/user/edit-profile' })
  }
}
```

## 🔐 微信绑定/解绑

### 绑定微信
```typescript
async function handleBindWechat() {
  const loginRes = await uni.login({ provider: 'weixin' })
  await api.auth.bindWechat({ code: loginRes.code })

  // 更新用户信息
  const profileRes = await api.auth.getProfile()
  userStore.setUserInfo(profileRes.user)
}
```

### 解绑微信
```typescript
async function handleUnbindWechat() {
  uni.showModal({
    title: '提示',
    content: '确定要解绑微信账号吗？',
    success: async (res) => {
      if (res.confirm) {
        const res = await api.auth.unbindWechat()
        userStore.setUserInfo(res.user)
        uni.showToast({ title: '解绑成功', icon: 'success' })
      }
    }
  })
}
```

## 🛡️ 安全机制

### 解绑保护
```typescript
// 检查是否还有其他登录方式
if (!user.email && !user.phone) {
  throw new Error('无法解绑：该账号仅支持微信登录，请先绑定手机号或邮箱');
}
```

### 登录验证
```typescript
// 检查密码登录时，微信用户不能用密码登录
if (!user.password) {
  throw new Error('该账号为微信登录，请使用微信登录');
}
```

## 📊 后端API列表

| API端点 | 方法 | 说明 | 认证 |
|---------|------|------|------|
| `/api/auth/wechat/login` | POST | 微信登录/注册 | ❌ |
| `/api/auth/wechat/bind` | POST | 绑定微信 | ✅ |
| `/api/auth/wechat/unbind` | POST | 解绑微信 | ✅ |
| `/api/auth/profile` | GET | 获取用户信息 | ✅ |

## 🎨 UI特性

### 未登录页面
- ✅ 欢迎图标和标题
- ✅ 绿色微信登录按钮
- ✅ 分隔线设计
- ✅ 传统登录选项
- ✅ 注册引导链接

### 已登录页面
- ✅ 头像显示（支持图片或文字）
- ✅ 微信绑定状态标识
- ✅ 完整个人信息展示
- ✅ 功能按钮组
- ✅ 微信绑定/解绑按钮
- ✅ 退出登录按钮

## 🔍 状态管理

### Pinia Store
```typescript
export const useUserStore = defineStore('user', () => {
  const token = ref<string>('')
  const userInfo = ref<any>(null)

  function setToken(newToken: string) {
    token.value = newToken
  }

  function setUserInfo(info: any) {
    userInfo.value = info
  }

  function logout() {
    token.value = ''
    userInfo.value = null
  }

  return { token, userInfo, setToken, setUserInfo, logout }
}, { persist: true })
```

## 📝 用户流程

### 新用户微信登录
```
点击微信登录 → 授权 → 自动注册 → 引导完善资料 → 进入个人中心
```

### 已有账号绑定微信
```
登录账号 → 个人中心 → 绑定微信 → 授权 → 绑定成功
```

### 解绑微信
```
个人中心 → 解绑微信 → 确认 → 检查其他登录方式 → 解绑成功
```

## 🚀 使用场景

### 场景1: 首次使用
用户打开小程序 → 进入"我的" → 看到登录界面 → 微信登录 → 完善资料

### 场景2: 已登录用户
用户打开小程序 → 进入"我的" → 看到个人信息 → 使用功能

### 场景3: 绑定微信
用户已登录 → 进入"我的" → 点击"绑定微信" → 授权 → 绑定成功

### 场景4: 退出登录
用户在"我的" → 点击"退出登录" → 确认 → 返回未登录状态

## 📋 修改的文件

1. **前端页面**: `frontend/src/pages/user/profile.vue`
2. **前端API**: `frontend/src/api/index.ts`
3. **后端服务**: `backend/src/modules/auth/auth.service.ts`
4. **后端控制器**: `backend/src/modules/auth/auth.controller.ts`

## ✅ 功能验证

### 测试用例
- [x] 未登录状态显示登录界面
- [x] 微信登录成功后显示用户信息
- [x] 已绑定微信显示"已绑定微信"标识
- [x] 未绑定微信显示"绑定微信"按钮
- [x] 解绑微信功能正常
- [x] 退出登录功能正常
- [x] 新用户引导完善资料

---

**最后更新**: 2026-01-11
**版本**: 1.0.0