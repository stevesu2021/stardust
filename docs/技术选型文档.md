# Stardust 技术选型文档

## 项目概述

Stardust 是一套支持多端部署的系统，包括 Web、Android App、iOS App、微信小程序、抖音小程序等平台。

## 技术栈

### 前端技术栈

**框架：Uni-app (Vue 3 + TypeScript)**

- **选择理由**：
  - 原生支持多端部署，一套代码可同时发布到多个平台
  - Vue 3 组合式 API，代码更简洁
  - TypeScript 支持，提高代码质量
  - 生态成熟，社区活跃
  - 性能优秀，接近原生体验

**UI 组件库：uView UI**
- 丰富的组件库，覆盖常见业务场景
- 良好的设计规范
- 持续更新维护

**状态管理：Pinia**
- Vue 3 官方推荐的状态管理库
- API 简洁，易于使用
- 支持 TypeScript
- 支持持久化插件

### 后端技术栈

**框架：Node.js + Nest.js (TypeScript)**

- **选择理由**：
  - 企业级框架，提供完整的架构模式
  - TypeScript 支持，类型安全
  - 模块化设计，易于维护和扩展
  - 依赖注入，提高代码可测试性
  - 丰富的装饰器，简化开发

**ORM：Prisma**
- 类型安全的 ORM
- 自动生成 TypeScript 类型
- 迁移管理简单
- 支持多种数据库
- 优秀的开发体验

**数据库：PostgreSQL**
- 开源关系型数据库
- 支持复杂查询
- 数据完整性保证
- 支持全文搜索
- 优秀的性能

**缓存：Redis**
- 高性能键值存储
- 支持多种数据结构
- 可用作缓存、消息队列
- 支持持久化

**认证：JWT + Passport**
- 无状态认证
- 跨平台支持
- 安全可靠
- 易于集成

## 核心功能实现

### 1. 阳历转农历

**技术方案**：
- 使用 `lunar-javascript` 库
- 支持精确到时辰的转换
- 提供完整的农历信息（年月日、干支等）

**实现位置**：
- 后端：[astrology.utils.ts](file:///home/steve/workspace/stardust/backend/src/common/utils/astrology.utils.ts)

### 2. 星座计算

**技术方案**：
- 根据阳历日期计算星座
- 使用日期范围判断逻辑

**实现位置**：
- 后端：[astrology.utils.ts](file:///home/steve/workspace/stardust/backend/src/common/utils/astrology.utils.ts)

### 3. 五行计算

**技术方案**：
- 基于八字（年月日时）计算五行
- 使用 `lunar-javascript` 库的八字功能
- 统计金木水火土的数量

**实现位置**：
- 后端：[astrology.utils.ts](file:///home/steve/workspace/stardust/backend/src/common/utils/astrology.utils.ts)

### 4. 复合祈愿（失恋后祈祷求复合）

**功能描述**：
- 用户可以发布祈愿内容
- 可指定对象姓名
- 其他用户可以为祈愿点赞
- 统计祈福次数

**实现位置**：
- 后端：[prayer.service.ts](file:///home/steve/workspace/stardust/backend/src/modules/prayer/prayer.service.ts)
- 前端：[prayer/list.vue](file:///home/steve/workspace/stardust/frontend/src/pages/prayer/list.vue)

### 5. 月老红线（暗恋告知月老）

**功能描述**：
- 匿名表白功能
- 可选择是否匿名
- 双向匹配机制
- 匹配成功后通知双方

**实现位置**：
- 后端：[confession.service.ts](file:///home/steve/workspace/stardust/backend/src/modules/confession/confession.service.ts)
- 前端：[confession/list.vue](file:///home/steve/workspace/stardust/frontend/src/pages/confession/list.vue)

### 6. 树洞

**功能描述**：
- 匿名发布心情
- 其他用户可以点赞
- 支持删除自己的内容

**实现位置**：
- 后端：[treehole.service.ts](file:///home/steve/workspace/stardust/backend/src/modules/treehole/treehole.service.ts)
- 前端：[treehole/list.vue](file:///home/steve/workspace/stardust/frontend/src/pages/treehole/list.vue)

### 7. 交友

**功能描述**：
- 基于星座和五行的匹配算法
- 推荐匹配度高的用户
- 支持私信聊天
- 消息已读状态管理

**实现位置**：
- 后端：[dating.service.ts](file:///home/steve/workspace/stardust/backend/src/modules/dating/dating.service.ts)
- 前端：[dating/matches.vue](file:///home/steve/workspace/stardust/frontend/src/pages/dating/matches.vue)

## 部署架构

### 前端部署

**Web 部署**：
- 构建命令：`npm run build:h5`
- 部署方式：Nginx + CDN
- 静态资源托管

**App 部署**：
- Android：打包 APK，发布到应用商店
- iOS：打包 IPA，发布到 App Store

**小程序部署**：
- 微信小程序：使用 HBuilderX 打包，提交审核
- 抖音小程序：使用 HBuilderX 打包，提交审核

### 后端部署

**开发环境**：
- 命令：`npm run start:dev`
- 端口：3000

**生产环境**：
- 构建命令：`npm run build`
- 运行命令：`npm run start:prod`
- 容器化：Docker + Docker Compose
- 反向代理：Nginx
- 负载均衡：Nginx / 云服务商 SLB

**数据库部署**：
- PostgreSQL：云数据库 RDS
- Redis：云数据库 Redis

## 项目结构

```
stardust/
├── frontend/                 # Uni-app 前端项目
│   ├── src/
│   │   ├── pages/          # 页面
│   │   ├── api/            # API 接口
│   │   ├── store/          # 状态管理
│   │   ├── App.vue         # 根组件
│   │   └── main.ts         # 入口文件
│   ├── pages.json           # 页面配置
│   ├── manifest.json        # 应用配置
│   ├── vite.config.ts      # Vite 配置
│   └── package.json        # 依赖配置
├── backend/                  # Nest.js 后端项目
│   ├── src/
│   │   ├── common/         # 公共模块
│   │   │   ├── prisma/     # Prisma 配置
│   │   │   ├── guards/     # 守卫
│   │   │   └── utils/      # 工具函数
│   │   ├── modules/        # 业务模块
│   │   │   ├── auth/       # 认证模块
│   │   │   ├── user/       # 用户模块
│   │   │   ├── astrology/  # 星座模块
│   │   │   ├── prayer/     # 祈愿模块
│   │   │   ├── confession/ # 表白模块
│   │   │   ├── treehole/   # 树洞模块
│   │   │   └── dating/     # 交友模块
│   │   ├── app.module.ts   # 应用模块
│   │   └── main.ts         # 入口文件
│   ├── prisma/
│   │   └── schema.prisma   # 数据库模型
│   └── package.json        # 依赖配置
└── docs/                     # 项目文档
```

## 开发指南

### 环境要求

- Node.js >= 18.0.0
- npm >= 9.0.0
- PostgreSQL >= 14.0
- Redis >= 6.0

### 安装依赖

```bash
# 安装所有依赖
npm run install:all

# 或分别安装
cd backend && npm install
cd frontend && npm install
```

### 配置环境变量

```bash
# 复制环境变量模板
cp backend/.env.example backend/.env

# 编辑环境变量
vim backend/.env
```

### 数据库初始化

```bash
cd backend

# 生成 Prisma Client
npm run prisma:generate

# 运行数据库迁移
npm run prisma:migrate
```

### 启动开发服务器

```bash
# 同时启动前后端
npm run dev

# 或分别启动
npm run dev:backend
npm run dev:frontend
```

### 构建生产版本

```bash
# 构建所有
npm run build

# 或分别构建
npm run build:backend
npm run build:frontend
```

## API 文档

### 认证接口

- `POST /api/auth/register` - 用户注册
- `POST /api/auth/login` - 用户登录

### 星座接口

- `POST /api/astrology/calculate/:userId` - 计算星盘

### 祈愿接口

- `POST /api/prayer` - 创建祈愿
- `GET /api/prayer/user/:userId` - 获取用户祈愿
- `GET /api/prayer/public` - 获取公开祈愿
- `POST /api/prayer/increment/:prayerId` - 增加祈福次数

### 表白接口

- `POST /api/confession` - 创建表白
- `GET /api/confession/user/:userId` - 获取用户表白
- `GET /api/confession/public` - 获取公开表白
- `POST /api/confession/match/:confessionId` - 检查匹配

### 树洞接口

- `POST /api/treehole` - 创建树洞
- `GET /api/treehole/user/:userId` - 获取用户树洞
- `GET /api/treehole/public` - 获取公开树洞
- `POST /api/treehole/like/:treeholeId` - 点赞树洞
- `DELETE /api/treehole/:treeholeId` - 删除树洞

### 交友接口

- `POST /api/dating/matches/:userId` - 获取匹配用户
- `POST /api/dating/message` - 发送消息
- `GET /api/dating/messages/:userId/:otherUserId` - 获取聊天记录
- `POST /api/dating/message/read/:messageId` - 标记消息已读

### 用户接口

- `GET /api/user/:id` - 获取用户信息
- `PUT /api/user/:id` - 更新用户信息
- `DELETE /api/user/:id` - 删除用户

## 注意事项

1. **安全性**：
   - 生产环境请修改 JWT_SECRET
   - 使用 HTTPS 部署
   - 定期更新依赖包

2. **性能优化**：
   - 使用 Redis 缓存热点数据
   - 数据库查询优化
   - 前端资源压缩

3. **扩展性**：
   - 模块化设计，易于添加新功能
   - 支持水平扩展
   - 支持微服务架构

## 许可证

MIT License