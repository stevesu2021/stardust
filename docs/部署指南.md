# Stardust 部署指南

## 环境要求

### 服务器要求

- **操作系统**：Linux (Ubuntu 20.04+ 推荐)
- **Node.js**：>= 18.0.0
- **npm**：>= 9.0.0
- **PostgreSQL**：>= 14.0
- **Redis**：>= 6.0
- **Nginx**：>= 1.18
- **Docker**：>= 20.10 (可选)
- **Docker Compose**：>= 2.0 (可选)

### 本地开发要求

- **Node.js**：>= 18.0.0
- **npm**：>= 9.0.0
- **HBuilderX**：>= 3.8.0 (用于小程序和 App 开发)

## 部署架构

```
                    ┌─────────────┐
                    │   用户      │
                    └──────┬──────┘
                           │
                    ┌──────▼──────┐
                    │   Nginx     │
                    │  (反向代理)  │
                    └──────┬──────┘
                           │
              ┌────────────┼────────────┐
              │            │            │
         ┌────▼────┐  ┌───▼────┐  ┌───▼────┐
         │   Web   │  │  App   │  │小程序  │
         │  (H5)   │  │(Native)│  │(Mini)  │
         └─────────┘  └────────┘  └────────┘
                           │
                    ┌──────▼──────┐
                    │  Nest.js    │
                    │  (后端API)  │
                    └──────┬──────┘
                           │
              ┌────────────┼────────────┐
              │            │            │
         ┌────▼────┐  ┌───▼────┐  ┌───▼────┐
         │PostgreSQL│  │ Redis  │  │  OSS   │
         │ (数据库) │  │ (缓存) │  │(文件)  │
         └─────────┘  └────────┘  └────────┘
```

## 后端部署

### 方式一：直接部署

#### 1. 安装依赖

```bash
# 安装 Node.js
curl -fsSL https://deb.nodesource.com/setup_18.x | sudo -E bash -
sudo apt-get install -y nodejs

# 安装 PostgreSQL
sudo apt-get install -y postgresql postgresql-contrib

# 安装 Redis
sudo apt-get install -y redis-server

# 安装 Nginx
sudo apt-get install -y nginx
```

#### 2. 配置数据库

```bash
# 切换到 postgres 用户
sudo -u postgres psql

# 创建数据库和用户
CREATE DATABASE stardust;
CREATE USER stardust_user WITH PASSWORD 'your_password';
GRANT ALL PRIVILEGES ON DATABASE stardust TO stardust_user;
\q
```

#### 3. 部署应用

```bash
# 克隆项目
git clone <repository-url>
cd stardust/backend

# 安装依赖
npm install

# 配置环境变量
cp .env.example .env
vim .env

# 编辑 DATABASE_URL
DATABASE_URL="postgresql://stardust_user:your_password@localhost:5432/stardust?schema=public"

# 生成 Prisma Client
npm run prisma:generate

# 运行数据库迁移
npm run prisma:migrate

# 构建项目
npm run build

# 使用 PM2 启动应用
npm install -g pm2
pm2 start dist/main.js --name stardust-backend
pm2 save
pm2 startup
```

#### 4. 配置 Nginx

```bash
# 创建 Nginx 配置文件
sudo vim /etc/nginx/sites-available/stardust-api
```

```nginx
server {
    listen 80;
    server_name api.yourdomain.com;

    location / {
        proxy_pass http://localhost:3000;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_cache_bypass $http_upgrade;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
}
```

```bash
# 启用配置
sudo ln -s /etc/nginx/sites-available/stardust-api /etc/nginx/sites-enabled/

# 测试配置
sudo nginx -t

# 重启 Nginx
sudo systemctl restart nginx
```

### 方式二：Docker 部署

#### 1. 创建 Dockerfile

```dockerfile
# backend/Dockerfile
FROM node:18-alpine

WORKDIR /app

COPY package*.json ./
RUN npm ci --only=production

COPY . .
RUN npm run build

EXPOSE 3000

CMD ["npm", "run", "start:prod"]
```

#### 2. 创建 docker-compose.yml

```yaml
version: '3.8'

services:
  postgres:
    image: postgres:14-alpine
    environment:
      POSTGRES_DB: stardust
      POSTGRES_USER: stardust_user
      POSTGRES_PASSWORD: your_password
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data

  redis:
    image: redis:6-alpine
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data

  backend:
    build: ./backend
    ports:
      - "3000:3000"
    environment:
      DATABASE_URL: postgresql://stardust_user:your_password@postgres:5432/stardust?schema=public
      JWT_SECRET: your_jwt_secret
      PORT: 3000
    depends_on:
      - postgres
      - redis
    command: sh -c "npx prisma generate && npx prisma migrate deploy && npm run start:prod"

volumes:
  postgres_data:
  redis_data:
```

#### 3. 启动服务

```bash
# 构建并启动
docker-compose up -d

# 查看日志
docker-compose logs -f backend

# 停止服务
docker-compose down
```

## 前端部署

### H5 部署

#### 1. 构建项目

```bash
cd frontend

# 安装依赖
npm install

# 构建生产版本
npm run build:h5
```

#### 2. 配置 Nginx

```bash
# 创建 Nginx 配置文件
sudo vim /etc/nginx/sites-available/stardust-web
```

```nginx
server {
    listen 80;
    server_name www.yourdomain.com;

    root /var/www/stardust-web/dist;
    index index.html;

    location / {
        try_files $uri $uri/ /index.html;
    }

    location /api {
        proxy_pass http://localhost:3000;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_cache_bypass $http_upgrade;
    }

    # 启用 Gzip 压缩
    gzip on;
    gzip_types text/plain text/css application/json application/javascript text/xml application/xml application/xml+rss text/javascript;
}
```

```bash
# 复制构建文件
sudo cp -r dist /var/www/stardust-web/

# 设置权限
sudo chown -R www-data:www-data /var/www/stardust-web

# 启用配置
sudo ln -s /etc/nginx/sites-available/stardust-web /etc/nginx/sites-enabled/

# 测试配置
sudo nginx -t

# 重启 Nginx
sudo systemctl restart nginx
```

#### 3. 配置 HTTPS（使用 Let's Encrypt）

```bash
# 安装 Certbot
sudo apt-get install -y certbot python3-certbot-nginx

# 获取证书
sudo certbot --nginx -d www.yourdomain.com

# 自动续期
sudo certbot renew --dry-run
```

### 小程序部署

#### 微信小程序

1. **配置小程序信息**：
   - 打开 `frontend/manifest.json`
   - 填写 `mp-weixin.appid`
   - 配置服务器域名

2. **打包小程序**：
   - 使用 HBuilderX 打开项目
   - 发行 → 小程序-微信
   - 等待打包完成

3. **上传审核**：
   - 使用微信开发者工具打开打包后的项目
   - 点击上传
   - 在微信公众平台提交审核

#### 抖音小程序

1. **配置小程序信息**：
   - 打开 `frontend/manifest.json`
   - 填写 `mp-toutiao.appid`
   - 配置服务器域名

2. **打包小程序**：
   - 使用 HBuilderX 打开项目
   - 发行 → 小程序-抖音
   - 等待打包完成

3. **上传审核**：
   - 使用抖音开发者工具打开打包后的项目
   - 点击上传
   - 在抖音开放平台提交审核

### App 部署

#### Android App

1. **配置应用信息**：
   - 打开 `frontend/manifest.json`
   - 配置 `app-plus` 相关信息
   - 填写应用名称、包名等

2. **打包 APK**：
   - 使用 HBuilderX 打开项目
   - 发行 → 原生App-云打包
   - 选择 Android 平台
   - 等待打包完成

3. **发布到应用商店**：
   - 注册开发者账号
   - 上传 APK
   - 填写应用信息
   - 提交审核

#### iOS App

1. **配置应用信息**：
   - 打开 `frontend/manifest.json`
   - 配置 `app-plus` 相关信息
   - 填写 Bundle ID 等

2. **打包 IPA**：
   - 使用 HBuilderX 打开项目
   - 发行 → 原生App-云打包
   - 选择 iOS 平台
   - 等待打包完成

3. **发布到 App Store**：
   - 使用 Xcode 打开项目
   - 配置签名和证书
   - 上传到 App Store Connect
   - 提交审核

## 监控与日志

### 后端监控

#### 1. 使用 PM2 监控

```bash
# 查看应用状态
pm2 list

# 查看日志
pm2 logs stardust-backend

# 查看实时日志
pm2 logs stardust-backend --lines 100

# 重启应用
pm2 restart stardust-backend

# 停止应用
pm2 stop stardust-backend

# 删除应用
pm2 delete stardust-backend
```

#### 2. 使用 Nginx 日志

```bash
# 访问日志
sudo tail -f /var/log/nginx/access.log

# 错误日志
sudo tail -f /var/log/nginx/error.log
```

### 数据库监控

#### 1. PostgreSQL 监控

```bash
# 查看数据库连接
sudo -u postgres psql -c "SELECT * FROM pg_stat_activity;"

# 查看数据库大小
sudo -u postgres psql -c "SELECT pg_size_pretty(pg_database_size('stardust'));"

# 查看表大小
sudo -u postgres psql -d stardust -c "SELECT relname, pg_size_pretty(pg_total_relation_size(relid)) FROM pg_catalog.pg_statio_user_tables ORDER BY pg_total_relation_size(relid) DESC;"
```

#### 2. Redis 监控

```bash
# 查看 Redis 信息
redis-cli INFO

# 查看内存使用
redis-cli INFO memory

# 查看连接数
redis-cli INFO clients
```

## 备份与恢复

### 数据库备份

```bash
# 备份 PostgreSQL
sudo -u postgres pg_dump stardust > stardust_backup_$(date +%Y%m%d).sql

# 恢复 PostgreSQL
sudo -u postgres psql stardust < stardust_backup_20240101.sql

# 备份 Redis
redis-cli SAVE
cp /var/lib/redis/dump.rdb /backup/redis_backup_$(date +%Y%m%d).rdb

# 恢复 Redis
cp /backup/redis_backup_20240101.rdb /var/lib/redis/dump.rdb
sudo systemctl restart redis
```

### 自动备份

```bash
# 创建备份脚本
vim /usr/local/bin/backup_stardust.sh
```

```bash
#!/bin/bash

BACKUP_DIR="/backup"
DATE=$(date +%Y%m%d_%H%M%S)

# 备份 PostgreSQL
sudo -u postgres pg_dump stardust > $BACKUP_DIR/stardust_$DATE.sql

# 备份 Redis
redis-cli BGSAVE
sleep 5
cp /var/lib/redis/dump.rdb $BACKUP_DIR/redis_$DATE.rdb

# 删除 7 天前的备份
find $BACKUP_DIR -name "stardust_*.sql" -mtime +7 -delete
find $BACKUP_DIR -name "redis_*.rdb" -mtime +7 -delete
```

```bash
# 添加执行权限
chmod +x /usr/local/bin/backup_stardust.sh

# 添加到 crontab
crontab -e

# 每天凌晨 2 点执行备份
0 2 * * * /usr/local/bin/backup_stardust.sh
```

## 性能优化

### 后端优化

1. **启用 Gzip 压缩**：
```bash
# 在 Nest.js 中启用压缩
npm install compression

# 在 main.ts 中使用
import * as compression from 'compression';
app.use(compression());
```

2. **配置 Redis 缓存**：
```bash
# 安装 Redis 客户端
npm install @nestjs/cache-manager cache-manager-ioredis
```

3. **数据库连接池优化**：
```prisma
// 在 schema.prisma 中配置连接池
datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
  connection_limit = 10
}
```

### 前端优化

1. **启用 CDN**：
   - 将静态资源上传到 CDN
   - 修改资源路径为 CDN 地址

2. **图片优化**：
   - 使用 WebP 格式
   - 压缩图片大小
   - 使用懒加载

3. **代码分割**：
   - 使用路由懒加载
   - 按需加载组件

## 安全加固

### 后端安全

1. **配置 CORS**：
```typescript
// 在 main.ts 中配置 CORS
app.enableCors({
  origin: ['https://www.yourdomain.com'],
  methods: 'GET,HEAD,PUT,PATCH,POST,DELETE,OPTIONS',
  credentials: true,
});
```

2. **启用 HTTPS**：
   - 使用 Let's Encrypt 免费证书
   - 配置 Nginx SSL

3. **限制请求频率**：
```bash
# 安装 rate-limit
npm install @nestjs/throttler
```

### 前端安全

1. **XSS 防护**：
   - 使用 Vue 的自动转义
   - 避免使用 v-html

2. **CSRF 防护**：
   - 使用 SameSite Cookie
   - 验证 Referer

3. **敏感信息保护**：
   - 不在前端存储敏感信息
   - 使用 HTTPS 传输

## 故障排查

### 常见问题

1. **服务无法启动**：
   - 检查端口是否被占用
   - 检查环境变量配置
   - 查看日志文件

2. **数据库连接失败**：
   - 检查数据库服务状态
   - 检查连接字符串
   - 检查防火墙设置

3. **API 请求失败**：
   - 检查后端服务状态
   - 检查网络连接
   - 查看 Nginx 日志

## 扩展阅读

- [Nest.js 官方文档](https://docs.nestjs.com/)
- [Uni-app 官方文档](https://uniapp.dcloud.net.cn/)
- [Prisma 官方文档](https://www.prisma.io/docs)
- [PostgreSQL 官方文档](https://www.postgresql.org/docs/)
- [Redis 官方文档](https://redis.io/documentation)
- [Nginx 官方文档](https://nginx.org/en/docs/)

## 许可证

MIT License