# å¤šç«¯é€‚é…æŠ€æœ¯æ–¹æ¡ˆ

## ğŸ“± Uni-app å¤šç«¯å¼€å‘æœ€ä½³å®è·µ

### ä¸€ã€é¡¹ç›®é…ç½®ä¼˜åŒ–

#### 1.1 pages.json å¤šç«¯é…ç½®
```json
{
  "pages": [
    {
      "path": "pages/index/index",
      "style": {
        "navigationBarTitleText": "æ˜Ÿå¥‘é›†",
        "navigationStyle": "custom",
        "mp-weixin": {
          "navigationBarTitleText": "æ˜Ÿå¥‘é›† - æ˜Ÿåº§å åœ"
        },
        "h5": {
          "navigationBarTitleText": "æ˜Ÿå¥‘é›† - ä¸“ä¸šå åœç¤¾äº¤å¹³å°"
        }
      }
    }
  ],
  "globalStyle": {
    "navigationBarTextStyle": "black",
    "navigationBarTitleText": "æ˜Ÿå¥‘é›†",
    "navigationBarBackgroundColor": "#F8F8F8",
    "backgroundColor": "#F8F8F8"
  },
  "tabBar": {
    "color": "#7A7E83",
    "selectedColor": "#667eea",
    "borderStyle": "black",
    "backgroundColor": "#ffffff",
    "list": [
      {
        "pagePath": "pages/index/index",
        "iconPath": "static/tab-home.png",
        "selectedIconPath": "static/tab-home-active.png",
        "text": "é¦–é¡µ"
      }
    ]
  },
  "condition": {
    "platform": ["h5", "mp-weixin", "mp-toutiao", "app"]
  }
}
```

#### 1.2 manifest.json å¤šç«¯é…ç½®
```json
{
  "name": "æ˜Ÿå¥‘é›†",
  "appid": "__UNI__XXXXXX",
  "versionName": "1.0.0",
  "versionCode": "100",

  "h5": {
    "title": "æ˜Ÿå¥‘é›† - ä¸“ä¸šå åœç¤¾äº¤å¹³å°",
    "template": "index.html",
    "router": {
      "mode": "history",
      "base": "/"
    },
    "devServer": {
      "port": 8080,
      "proxy": {
        "/api": {
          "target": "http://localhost:3000",
          "changeOrigin": true
        }
      }
    },
    "optimization": {
      "treeShaking": true,
      "gzip": true,
      "preload": true
    }
  },

  "mp-weixin": {
    "appid": "wxXXXXXXXXXXXXXX",
    "usingComponents": true,
    "plugins": {},
    "optimization": {
      "lazyCodeLoading": "requiredComponents"
    }
  },

  "mp-toutiao": {
    "appid": "ttXXXXXXXXXXXXXX",
    "usingComponents": true
  },

  "app-plus": {
    "distribute": {
      "ios": {
        "appid": "com.stardust.app",
        "privacyDescription": "æˆ‘ä»¬é‡è§†æ‚¨çš„éšç§ä¿æŠ¤",
        "capabilities": {
          "push": true,
          "location": true
        }
      },
      "android": {
        "packagename": "com.stardust.app",
        "permissions": [
          "<uses-permission android:name=\"android.permission.INTERNET\"/>",
          "<uses-permission android:name=\"android.permission.ACCESS_NETWORK_STATE\"/>"
        ]
      }
    }
  }
}
```

### äºŒã€æ ·å¼é€‚é…æ–¹æ¡ˆ

#### 2.1 å“åº”å¼å·¥å…·ç±»
```scss
// src/styles/mixins.scss

// å¹³å°æ£€æµ‹
@mixin platform($platform) {
  @if $platform == 'h5' {
    @media screen and (min-width: 768px) {
      @content;
    }
  } @else if $platform == 'mp-weixin' {
    @supports (font: -apple-system-body) {
      @content;
    }
  } @else if $platform == 'app' {
    @content;
  }
}

// å°ºå¯¸é€‚é…
@function rpx($value) {
  @return $value * 1rpx;
}

@function px($value) {
  @return $value * 1px;
}

// å®‰å…¨åŒºåŸŸé€‚é…
@mixin safe-area-top {
  padding-top: constant(safe-area-inset-top);
  padding-top: env(safe-area-inset-top);
}

@mixin safe-area-bottom {
  padding-bottom: constant(safe-area-inset-bottom);
  padding-bottom: env(safe-area-inset-bottom);
}

// æ··åˆç¤ºä¾‹
.container {
  padding: rpx(40);

  @include platform('h5') {
    max-width: 750px;
    margin: 0 auto;
    padding: px(20);
  }

  @include safe-area-top;
  @include safe-area-bottom;
}
```

#### 2.2 å¹³å°ç‰¹å®šæ ·å¼
```scss
// src/styles/platform.scss

/* H5 ä¼˜åŒ– */
.h5-only {
  /* H5 ç‰¹å®šæ ·å¼ */
  @media (hover: hover) {
    &:hover {
      opacity: 0.8;
    }
  }
}

/* å°ç¨‹åºä¼˜åŒ– */
.mp-weixin-only {
  /* å°ç¨‹åºç‰¹å®šæ ·å¼ */
  -webkit-overflow-scrolling: touch;
}

/* App ä¼˜åŒ– */
.app-only {
  /* App ç‰¹å®šæ ·å¼ */
  font-family: -apple-system, BlinkMacSystemFont;
}
```

#### 2.3 ç»„ä»¶æ ·å¼ç¤ºä¾‹
```vue
<!-- src/components/FeatureCard.vue -->
<template>
  <view
    class="feature-card"
    :class="[platformClass]"
    @click="handleClick"
  >
    <image class="icon" :src="icon" mode="aspectFit" />
    <text class="title">{{ title }}</text>
    <text class="desc">{{ desc }}</text>
  </view>
</template>

<script setup lang="ts">
import { computed } from 'vue'

const props = defineProps<{
  icon: string
  title: string
  desc: string
}>()

const platformClass = computed(() => {
  const system = uni.getSystemInfoSync()
  if (system.platform === 'devtools') return 'dev'
  if (system.platform === 'h5') return 'h5'
  if (system.platform === 'weixin') return 'weixin'
  return 'app'
})

const handleClick = () => {
  uni.vibrateShort() // éœ‡åŠ¨åé¦ˆ (App/å°ç¨‹åº)
}
</script>

<style lang="scss" scoped>
.feature-card {
  background: #fff;
  border-radius: 20rpx;
  padding: 40rpx;
  text-align: center;
  box-shadow: 0 4rpx 20rpx rgba(0, 0, 0, 0.08);
  transition: all 0.3s;

  // åŸºç¡€æ ·å¼ (æ‰€æœ‰å¹³å°)
  .icon {
    width: 80rpx;
    height: 80rpx;
    margin-bottom: 20rpx;
  }

  .title {
    display: block;
    font-size: 32rpx;
    font-weight: bold;
    color: #333;
    margin-bottom: 10rpx;
  }

  .desc {
    display: block;
    font-size: 24rpx;
    color: #999;
  }

  // H5 ä¼˜åŒ–
  &.h5 {
    @media (hover: hover) {
      &:hover {
        transform: translateY(-4px);
        box-shadow: 0 8rpx 30rpx rgba(0, 0, 0, 0.12);
      }
    }

    @media (min-width: 768px) {
      padding: px(30);
      min-width: 200px;
    }
  }

  // å°ç¨‹åºä¼˜åŒ–
  &.weixin {
    -webkit-tap-highlight-color: transparent;

    &:active {
      opacity: 0.7;
    }
  }

  // App ä¼˜åŒ–
  &.app {
    // App ç‰¹å®šæ ·å¼
  }
}
</style>
```

### ä¸‰ã€API é€‚é…æ–¹æ¡ˆ

#### 3.1 ç»Ÿä¸€è¯·æ±‚å°è£…
```typescript
// src/api/request.ts

const BASE_URLS = {
  h5: '/api',
  'mp-weixin': 'https://your-domain.com/api',
  'mp-toutiao': 'https://your-domain.com/api',
  app: 'https://your-domain.com/api'
}

export function getBaseUrl(): string {
  const system = uni.getSystemInfoSync()
  const platform = system.platform

  // å¼€å‘ç¯å¢ƒ
  if (process.env.NODE_ENV === 'development') {
    return '/api'
  }

  // ç”Ÿäº§ç¯å¢ƒ
  if (platform === 'h5') {
    return '/api'
  }

  return BASE_URLS[platform as keyof typeof BASE_URLS] || '/api'
}

export function request<T = any>(options: RequestOptions): Promise<T> {
  const { url, method = 'GET', data, header = {} } = options

  // å¹³å°ç‰¹å®š header
  const platformHeaders: Record<string, string> = {
    'X-Platform': uni.getSystemInfoSync().platform,
    'X-Version': '1.0.0'
  }

  // å°ç¨‹åºç‰¹å®šå¤„ç†
  if (uni.getSystemInfoSync().platform === 'weixin') {
    // å¾®ä¿¡ç™»å½•æ€å¤„ç†
    const token = uni.getStorageSync('token')
    if (token) {
      platformHeaders['Authorization'] = `Bearer ${token}`
    }
  }

  return new Promise((resolve, reject) => {
    uni.request({
      url: getBaseUrl() + url,
      method,
      data,
      header: {
        'Content-Type': 'application/json',
        ...platformHeaders,
        ...header
      },
      success: (res: any) => {
        if (res.statusCode === 200) {
          resolve(res.data)
        } else if (res.statusCode === 401) {
          // æœªæˆæƒï¼Œè·³è½¬ç™»å½•
          uni.removeStorageSync('token')
          uni.navigateTo({ url: '/pages/auth/login' })
          reject(new Error('æœªæˆæƒ'))
        } else {
          reject(new Error(res.data.message || 'è¯·æ±‚å¤±è´¥'))
        }
      },
      fail: (err) => {
        // ç½‘ç»œé”™è¯¯å¤„ç†
        if (err.errMsg.includes('timeout')) {
          uni.showToast({ title: 'ç½‘ç»œè¶…æ—¶', icon: 'none' })
        } else {
          uni.showToast({ title: 'ç½‘ç»œé”™è¯¯', icon: 'none' })
        }
        reject(err)
      }
    })
  })
}
```

#### 3.2 ç™»å½•æ€é€‚é…
```typescript
// src/utils/auth.ts

export class AuthService {

  // å¾®ä¿¡ç™»å½•
  static async weixinLogin(): Promise<string> {
    return new Promise((resolve, reject) => {
      uni.login({
        provider: 'weixin',
        success: async (loginRes) => {
          try {
            const code = loginRes.code
            // å‘é€ code åˆ°åç«¯æ¢å– token
            const result = await api.auth.weixinLogin({ code })
            uni.setStorageSync('token', result.token)
            resolve(result.token)
          } catch (error) {
            reject(error)
          }
        },
        fail: reject
      })
    })
  }

  // æŠ–éŸ³ç™»å½•
  static async toutiaoLogin(): Promise<string> {
    return new Promise((resolve, reject) => {
      uni.login({
        provider: 'toutiao',
        success: async (loginRes) => {
          const code = loginRes.code
          const result = await api.auth.toutiaoLogin({ code })
          uni.setStorageSync('token', result.token)
          resolve(result.token)
        },
        fail: reject
      })
    })
  }

  // App ç™»å½• (æ‰‹æœºå·)
  static async appLogin(phone: string, code: string): Promise<string> {
    const result = await api.auth.login({ phone, code })
    uni.setStorageSync('token', result.token)
    return result.token
  }

  // H5 ç™»å½•
  static async h5Login(email: string, password: string): Promise<string> {
    const result = await api.auth.login({ email, password })
    uni.setStorageSync('token', result.token)
    return result.token
  }

  // ç»Ÿä¸€ç™»å½•å…¥å£
  static async login(): Promise<string> {
    const platform = uni.getSystemInfoSync().platform

    switch (platform) {
      case 'weixin':
        return await this.weixinLogin()
      case 'toutiao':
        return await this.toutiaoLogin()
      case 'h5':
        // è·³è½¬åˆ°ç™»å½•é¡µ
        uni.navigateTo({ url: '/pages/auth/login' })
        return ''
      default:
        // App æˆ–å…¶ä»–
        uni.navigateTo({ url: '/pages/auth/login' })
        return ''
    }
  }
}
```

### å››ã€UI ç»„ä»¶å¤šç«¯é€‚é…

#### 4.1 æŒ‰é’®ç»„ä»¶
```vue
<!-- src/components/UniButton.vue -->
<template>
  <button
    class="uni-button"
    :class="[type, size, { disabled, loading }]"
    :disabled="disabled || loading"
    @click="handleClick"
  >
    <view v-if="loading" class="loading-icon">
      <uni-icons type="spinner" size="16" color="#fff" />
    </view>
    <slot>{{ text }}</slot>
  </button>
</template>

<script setup lang="ts">
import { computed } from 'vue'

const props = withDefaults(defineProps<{
  type?: 'primary' | 'secondary' | 'ghost'
  size?: 'small' | 'medium' | 'large'
  text?: string
  disabled?: boolean
  loading?: boolean
}>(), {
  type: 'primary',
  size: 'medium',
  text: 'æŒ‰é’®',
  disabled: false,
  loading: false
})

const emit = defineEmits(['click'])

const handleClick = (e: Event) => {
  if (props.disabled || props.loading) return

  // å¹³å°ç‰¹å®šåé¦ˆ
  const system = uni.getSystemInfoSync()
  if (system.platform === 'weixin' || system.platform === 'app') {
    uni.vibrateShort()
  }

  emit('click', e)
}
</script>

<style lang="scss" scoped>
.uni-button {
  border: none;
  border-radius: 12rpx;
  font-size: 32rpx;
  font-weight: 500;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all 0.2s;

  // å°ºå¯¸
  &.small {
    height: 64rpx;
    padding: 0 24rpx;
    font-size: 28rpx;
  }

  &.medium {
    height: 88rpx;
    padding: 0 32rpx;
  }

  &.large {
    height: 100rpx;
    padding: 0 40rpx;
    font-size: 36rpx;
  }

  // ç±»å‹
  &.primary {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: #fff;

    @media (hover: hover) and (pointer: fine) {
      &:hover:not(.disabled) {
        opacity: 0.9;
        transform: translateY(-1px);
      }
    }
  }

  &.secondary {
    background: #f0f0f0;
    color: #333;
  }

  &.ghost {
    background: transparent;
    color: #667eea;
    border: 2rpx solid #667eea;
  }

  // çŠ¶æ€
  &.disabled {
    opacity: 0.5;
    cursor: not-allowed;
  }

  &.loading {
    opacity: 0.7;
    cursor: wait;
  }

  // åŠ è½½åŠ¨ç”»
  .loading-icon {
    margin-right: 12rpx;
    animation: spin 1s linear infinite;
  }

  @keyframes spin {
    from { transform: rotate(0deg); }
    to { transform: rotate(360deg); }
  }
}
</style>
```

#### 4.2 å¼¹çª—ç»„ä»¶
```vue
<!-- src/components/UniModal.vue -->
<template>
  <view v-if="visible" class="modal-overlay" @click="handleOverlayClick">
    <view
      class="modal-content"
      :class="[platformClass, { 'show': showContent }]"
      @click.stop
    >
      <view class="modal-header">
        <text class="title">{{ title }}</text>
        <view v-if="closable" class="close-btn" @click="handleClose">
          <text>Ã—</text>
        </view>
      </view>

      <view class="modal-body">
        <slot>{{ content }}</slot>
      </view>

      <view class="modal-footer">
        <button
          v-if="showCancel"
          class="btn btn-cancel"
          @click="handleCancel"
        >
          {{ cancelText }}
        </button>
        <button
          class="btn btn-confirm"
          :class="{ primary: confirmType === 'primary' }"
          @click="handleConfirm"
        >
          {{ confirmText }}
        </button>
      </view>
    </view>
  </view>
</template>

<script setup lang="ts">
import { ref, watch, computed } from 'vue'

const props = withDefaults(defineProps<{
  visible: boolean
  title?: string
  content?: string
  closable?: boolean
  showCancel?: boolean
  cancelText?: string
  confirmText?: string
  confirmType?: 'primary' | 'default'
  closeOnOverlay?: boolean
}>(), {
  title: 'æç¤º',
  content: '',
  closable: false,
  showCancel: true,
  cancelText: 'å–æ¶ˆ',
  confirmText: 'ç¡®å®š',
  confirmType: 'primary',
  closeOnOverlay: true
})

const emit = defineEmits(['update:visible', 'confirm', 'cancel', 'close'])

const showContent = ref(false)

watch(() => props.visible, (val) => {
  if (val) {
    setTimeout(() => showContent.value = true, 10)
  } else {
    showContent.value = false
  }
})

const platformClass = computed(() => {
  const platform = uni.getSystemInfoSync().platform
  return platform === 'h5' ? 'h5-modal' : 'app-modal'
})

const handleOverlayClick = () => {
  if (props.closeOnOverlay) {
    handleClose()
  }
}

const handleClose = () => {
  showContent.value = false
  setTimeout(() => {
    emit('update:visible', false)
    emit('close')
  }, 200)
}

const handleCancel = () => {
  handleClose()
  emit('cancel')
}

const handleConfirm = () => {
  emit('confirm')
  if (props.closeOnOverlay) {
    handleClose()
  }
}
</script>

<style lang="scss" scoped>
.modal-overlay {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(0, 0, 0, 0.5);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 999;

  // H5 ä¼˜åŒ–
  &.h5-modal {
    backdrop-filter: blur(4px);
  }
}

.modal-content {
  background: #fff;
  border-radius: 24rpx;
  width: 80%;
  max-width: 600rpx;
  transform: scale(0.9);
  opacity: 0;
  transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);

  &.show {
    transform: scale(1);
    opacity: 1;
  }

  // App æ ·å¼
  &.app-modal {
    box-shadow: 0 20rpx 60rpx rgba(0, 0, 0, 0.3);
  }

  // H5 æ ·å¼
  &.h5-modal {
    box-shadow: 0 20rpx 60rpx rgba(0, 0, 0, 0.2);
  }
}

.modal-header {
  padding: 32rpx;
  border-bottom: 1rpx solid #f0f0f0;
  display: flex;
  align-items: center;
  justify-content: space-between;

  .title {
    font-size: 36rpx;
    font-weight: bold;
    color: #333;
  }

  .close-btn {
    width: 48rpx;
    height: 48rpx;
    display: flex;
    align-items: center;
    justify-content: center;
    color: #999;
    font-size: 36rpx;
  }
}

.modal-body {
  padding: 40rpx 32rpx;
  font-size: 32rpx;
  color: #666;
  line-height: 1.6;
}

.modal-footer {
  padding: 24rpx 32rpx 32rpx;
  display: flex;
  gap: 16rpx;

  .btn {
    flex: 1;
    height: 80rpx;
    border-radius: 12rpx;
    font-size: 32rpx;
    font-weight: 500;
    border: none;
    display: flex;
    align-items: center;
    justify-content: center;

    &.btn-cancel {
      background: #f0f0f0;
      color: #666;
    }

    &.btn-confirm {
      background: #e0e0e0;
      color: #666;

      &.primary {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: #fff;
      }
    }
  }
}
</style>
```

### äº”ã€æ€§èƒ½ä¼˜åŒ–ç­–ç•¥

#### 5.1 å›¾ç‰‡ä¼˜åŒ–
```typescript
// src/utils/image.ts

export class ImageOptimizer {

  // æ ¹æ®å¹³å°è¿”å›åˆé€‚çš„å›¾ç‰‡ URL
  static getOptimizedUrl(url: string, width?: number, height?: number): string {
    const platform = uni.getSystemInfoSync().platform

    if (!url) return ''

    // H5: ä½¿ç”¨ CDN ä¼˜åŒ–
    if (platform === 'h5') {
      const params = []
      if (width) params.push(`w=${width}`)
      if (height) params.push(`h=${height}`)
      return url + (params.length ? '?' + params.join('&') : '')
    }

    // å°ç¨‹åº: ä½¿ç”¨äº‘å­˜å‚¨ç¼©ç•¥å›¾
    if (platform === 'weixin' || platform === 'toutiao') {
      // å‡è®¾ä½¿ç”¨äº‘å¼€å‘
      return url.replace('cloud://', 'https://')
    }

    return url
  }

  // å›¾ç‰‡é¢„åŠ è½½
  static preloadImages(urls: string[]): Promise<void[]> {
    return Promise.all(
      urls.map(url => {
        return new Promise<void>((resolve) => {
          uni.getImageInfo({
            src: url,
            success: () => resolve(),
            fail: () => resolve()
          })
        })
      })
    )
  }

  // å‹ç¼©å›¾ç‰‡ (App ç«¯)
  static async compressImage(path: string): Promise<string> {
    return new Promise((resolve, reject) => {
      // ä»…åœ¨ App ç«¯æ”¯æŒ
      if (uni.getSystemInfoSync().platform !== 'app') {
        resolve(path)
        return
      }

      uni.compressImage({
        src: path,
        quality: 80,
        success: (res) => resolve(res.tempFilePath),
        fail: reject
      })
    })
  }
}
```

#### 5.2 æ•°æ®ç¼“å­˜
```typescript
// src/utils/cache.ts

export class CacheManager {
  private static instance: CacheManager
  private cachePrefix = 'stardust_cache_'

  static getInstance(): CacheManager {
    if (!this.instance) {
      this.instance = new CacheManager()
    }
    return this.instance
  }

  // è®¾ç½®ç¼“å­˜
  set(key: string, data: any, expire: number = 3600): void {
    const cacheData = {
      data,
      expire: Date.now() + expire * 1000
    }
    uni.setStorageSync(this.cachePrefix + key, cacheData)
  }

  // è·å–ç¼“å­˜
  get<T>(key: string): T | null {
    try {
      const cacheData = uni.getStorageSync(this.cachePrefix + key)
      if (!cacheData) return null

      if (Date.now() > cacheData.expire) {
        this.remove(key)
        return null
      }

      return cacheData.data
    } catch {
      return null
    }
  }

  // ç§»é™¤ç¼“å­˜
  remove(key: string): void {
    uni.removeStorageSync(this.cachePrefix + key)
  }

  // æ¸…ç©ºç¼“å­˜
  clear(): void {
    const keys = uni.getStorageInfoSync().keys
    keys.forEach(key => {
      if (key.startsWith(this.cachePrefix)) {
        uni.removeStorageSync(key)
      }
    })
  }

  // ç¼“å­˜è¯·æ±‚
  async cacheRequest<T>(
    key: string,
    request: () => Promise<T>,
    expire: number = 3600
  ): Promise<T> {
    const cached = this.get<T>(key)
    if (cached !== null) {
      return cached
    }

    const data = await request()
    this.set(key, data, expire)
    return data
  }
}
```

#### 5.3 æ‡’åŠ è½½ä¸åˆ†é¡µ
```vue
<!-- src/components/InfiniteList.vue -->
<template>
  <scroll-view
    class="scroll-view"
    :scroll-y="true"
    :lower-threshold="100"
    @scrolltolower="handleLoadMore"
  >
    <view class="list">
      <slot name="item" v-for="item in list" :key="item.id" :item="item" />
    </view>

    <view class="loading-more" v-if="loading">
      <text>åŠ è½½ä¸­...</text>
    </view>

    <view class="no-more" v-if="noMore && list.length > 0">
      <text>æ²¡æœ‰æ›´å¤šäº†</text>
    </view>

    <view class="empty" v-if="list.length === 0 && !loading">
      <text>æš‚æ— æ•°æ®</text>
    </view>
  </scroll-view>
</template>

<script setup lang="ts">
import { ref, onMounted } from 'vue'

const props = defineProps<{
  fetch: (page: number, size: number) => Promise<any[]>
  size?: number
}>()

const list = ref<any[]>([])
const page = ref(0)
const loading = ref(false)
const noMore = ref(false)

const loadMore = async () => {
  if (loading.value || noMore.value) return

  loading.value = true
  try {
    const data = await props.fetch(page.value, props.size || 20)

    if (data.length < (props.size || 20)) {
      noMore.value = true
    }

    list.value = [...list.value, ...data]
    page.value++
  } catch (error) {
    console.error('åŠ è½½å¤±è´¥', error)
  } finally {
    loading.value = false
  }
}

const handleLoadMore = () => {
  loadMore()
}

onMounted(() => {
  loadMore()
})

defineExpose({
  refresh: async () => {
    list.value = []
    page.value = 0
    noMore.value = false
    await loadMore()
  }
})
</script>

<style lang="scss" scoped>
.scroll-view {
  height: 100vh;

  .list {
    padding: 20rpx;
  }

  .loading-more,
  .no-more,
  .empty {
    text-align: center;
    padding: 40rpx;
    color: #999;
    font-size: 28rpx;
  }
}
</style>
```

### å…­ã€å¹³å°ç‰¹å®šåŠŸèƒ½å¤„ç†

#### 6.1 åˆ†äº«åŠŸèƒ½
```typescript
// src/utils/share.ts

export class ShareService {

  // è·å–åˆ†äº«é…ç½®
  static getShareConfig(type: string, data: any): any {
    const platform = uni.getSystemInfoSync().platform

    const baseConfig = {
      title: 'æ˜Ÿå¥‘é›† - æ¢ç´¢ä½ çš„æ˜Ÿåº§ä¸ç¼˜åˆ†',
      path: '/pages/index/index',
      imageUrl: 'https://your-cdn.com/share-bg.jpg'
    }

    switch (type) {
      case 'prayer':
        return {
          ...baseConfig,
          title: `æˆ‘åœ¨æ˜Ÿå¥‘é›†ç¥ˆæ„¿${data.targetName || 'å¤åˆ'}ï¼Œå¿«æ¥ä¸ºæˆ‘ç¥ç¦å§ï¼`,
          path: `/pages/prayer/detail?id=${data.id}`
        }

      case 'confession':
        return {
          ...baseConfig,
          title: 'æœˆè€çº¢çº¿ï¼Œå‘½ä¸­æ³¨å®šçš„ç¼˜åˆ†',
          path: `/pages/confession/detail?id=${data.id}`
        }

      case 'treehole':
        return {
          ...baseConfig,
          title: 'åŒ¿åæ ‘æ´ï¼Œè¯´å‡ºä½ çš„å¿ƒäº‹',
          path: `/pages/treehole/detail?id=${data.id}`
        }

      default:
        return baseConfig
    }
  }

  // åˆ†äº«åˆ°å¥½å‹/æœ‹å‹åœˆ
  static share(type: string, data: any): Promise<void> {
    const config = this.getShareConfig(type, data)
    const platform = uni.getSystemInfoSync().platform

    return new Promise((resolve, reject) => {
      if (platform === 'weixin') {
        uni.showActionSheet({
          itemList: ['åˆ†äº«ç»™å¥½å‹', 'åˆ†äº«åˆ°æœ‹å‹åœˆ'],
          success: (res) => {
            if (res.tapIndex === 0) {
              // åˆ†äº«ç»™å¥½å‹
              uni.share({
                provider: 'weixin',
                type: 0,
                ...config,
                success: () => resolve(),
                fail: reject
              })
            } else {
              // åˆ†äº«åˆ°æœ‹å‹åœˆ (ç”Ÿæˆæµ·æŠ¥)
              this.generatePoster(config).then(resolve).catch(reject)
            }
          },
          fail: reject
        })
      } else if (platform === 'h5') {
        // H5: å¤åˆ¶é“¾æ¥æˆ–è°ƒç”¨ Web Share API
        if (navigator.share) {
          navigator.share({
            title: config.title,
            url: location.origin + config.path
          }).then(resolve).catch(() => {
            // é™çº§ï¼šå¤åˆ¶é“¾æ¥
            uni.setClipboardData({
              data: location.origin + config.path,
              success: resolve,
              fail: reject
            })
          })
        } else {
          uni.setClipboardData({
            data: location.origin + config.path,
            success: resolve,
            fail: reject
          })
        }
      } else {
        // å…¶ä»–å¹³å°ï¼šå¤åˆ¶é“¾æ¥
        uni.setClipboardData({
          data: location.origin + config.path,
          success: resolve,
          fail: reject
        })
      }
    })
  }

  // ç”Ÿæˆæµ·æŠ¥ (å°ç¨‹åº/App)
  private static async generatePoster(config: any): Promise<void> {
    // ä½¿ç”¨ Canvas ç”Ÿæˆæµ·æŠ¥
    return new Promise((resolve, reject) => {
      const ctx = uni.createCanvasContext('shareCanvas')

      // ç»˜åˆ¶èƒŒæ™¯
      ctx.fillStyle = '#667eea'
      ctx.fillRect(0, 0, 750, 1334)

      // ç»˜åˆ¶æ–‡å­—
      ctx.fillStyle = '#fff'
      ctx.font = 'bold 40rpx sans-serif'
      ctx.fillText(config.title, 50, 200)

      ctx.draw(false, () => {
        uni.canvasToTempFilePath({
          canvasId: 'shareCanvas',
          success: (res) => {
            uni.saveImageToPhotosAlbum({
              filePath: res.tempFilePath,
              success: () => {
                uni.showToast({ title: 'æµ·æŠ¥å·²ä¿å­˜åˆ°ç›¸å†Œ', icon: 'success' })
                resolve()
              },
              fail: reject
            })
          },
          fail: reject
        })
      })
    })
  }
}
```

#### 6.2 æ”¯ä»˜åŠŸèƒ½
```typescript
// src/utils/payment.ts

export class PaymentService {

  // å‘èµ·æ”¯ä»˜
  static async pay(orderId: string, amount: number, type: 'vip' | 'consult' | 'custom'): Promise<void> {
    const platform = uni.getSystemInfoSync().platform

    // 1. è·å–æ”¯ä»˜å‚æ•°
    const payParams = await api.payment.getPayParams({
      orderId,
      platform
    })

    // 2. è°ƒç”¨å¹³å°æ”¯ä»˜
    if (platform === 'weixin') {
      await this.wechatPay(payParams)
    } else if (platform === 'h5') {
      await this.h5Pay(payParams)
    } else if (platform === 'app') {
      await this.appPay(payParams)
    } else {
      throw new Error('ä¸æ”¯æŒçš„æ”¯ä»˜å¹³å°')
    }

    // 3. æ”¯ä»˜æˆåŠŸå¤„ç†
    uni.showToast({ title: 'æ”¯ä»˜æˆåŠŸ', icon: 'success' })
  }

  // å¾®ä¿¡æ”¯ä»˜
  private static async wechatPay(params: any): Promise<void> {
    return new Promise((resolve, reject) => {
      uni.requestPayment({
        provider: 'weixin',
        timeStamp: params.timeStamp,
        nonceStr: params.nonceStr,
        package: params.package,
        signType: params.signType,
        paySign: params.paySign,
        success: () => resolve(),
        fail: (err) => {
          if (err.errMsg.includes('cancel')) {
            uni.showToast({ title: 'æ”¯ä»˜å·²å–æ¶ˆ', icon: 'none' })
          } else {
            uni.showToast({ title: 'æ”¯ä»˜å¤±è´¥', icon: 'none' })
          }
          reject(err)
        }
      })
    })
  }

  // H5 æ”¯ä»˜ (å¾®ä¿¡å†…/æ”¯ä»˜å®ç­‰)
  private static async h5Pay(params: any): Promise<void> {
    // å¾®ä¿¡å†…æµè§ˆå™¨
    if (navigator.userAgent.includes('MicroMessenger')) {
      // å¾®ä¿¡ H5 æ”¯ä»˜
      window.location.href = params.mweb_url
    } else {
      // å…¶ä»–æµè§ˆå™¨ï¼šè·³è½¬åˆ°æ”¯ä»˜é¡µé¢
      uni.navigateTo({
        url: `/pages/payment/h5?orderId=${params.orderId}`
      })
    }
  }

  // App æ”¯ä»˜
  private static async appPay(params: any): Promise<void> {
    // App ç«¯è°ƒç”¨åŸç”Ÿæ”¯ä»˜ SDK
    return new Promise((resolve, reject) => {
      uni.requestPayment({
        provider: 'applepay', // æˆ– 'alipay', 'wxpay'
        orderInfo: params.orderInfo,
        success: () => resolve(),
        fail: reject
      })
    })
  }
}
```

### ä¸ƒã€è°ƒè¯•ä¸æµ‹è¯•

#### 7.1 å¤šç«¯è°ƒè¯•å·¥å…·
```typescript
// src/utils/debug.ts

export class DebugHelper {

  // å¹³å°ä¿¡æ¯æ‰“å°
  static logPlatformInfo(): void {
    const system = uni.getSystemInfoSync()
    console.log('=== å¹³å°ä¿¡æ¯ ===')
    console.log('å¹³å°:', system.platform)
    console.log('ç³»ç»Ÿ:', system.system)
    console.log('å“ç‰Œ:', system.brand)
    console.log('å‹å·:', system.model)
    console.log('å±å¹•å®½:', system.screenWidth)
    console.log('å±å¹•é«˜:', system.screenHeight)
    console.log('çŠ¶æ€æ é«˜åº¦:', system.statusBarHeight)
    console.log('å¯¼èˆªæ é«˜åº¦:', system.safeArea?.top)
  }

  // æ€§èƒ½ç›‘æ§
  static monitorPerformance(): void {
    const startTime = Date.now()

    return {
      start: () => {
        return Date.now()
      },
      end: (start: number, label: string) => {
        const duration = Date.now() - start
        console.log(`[${label}] è€—æ—¶: ${duration}ms`)
        return duration
      }
    }
  }

  // çœŸæœºè°ƒè¯•ä¿¡æ¯
  static logDeviceInfo(): void {
    const system = uni.getSystemInfoSync()

    // è·å–å­˜å‚¨ä¿¡æ¯
    const storageInfo = uni.getStorageInfoSync()

    console.log('=== çœŸæœºä¿¡æ¯ ===')
    console.log('å½“å‰å­˜å‚¨:', storageInfo.currentSize, 'KB')
    console.log('å­˜å‚¨ä¸Šé™:', storageInfo.limitSize, 'KB')
    console.log('å¯ç”¨å­˜å‚¨:', (storageInfo.limitSize - storageInfo.currentSize), 'KB')
  }
}
```

#### 7.2 å•å…ƒæµ‹è¯•é…ç½®
```typescript
// frontend/test/utils/request.test.ts

import { describe, it, expect, vi } from 'vitest'
import { request, getBaseUrl } from '@/api/request'

describe('Request Utils', () => {
  it('åº”è¯¥è¿”å›æ­£ç¡®çš„åŸºç¡€URL', () => {
    // æ¨¡æ‹Ÿä¸åŒå¹³å°
    const originalPlatform = uni.getSystemInfoSync().platform

    // æµ‹è¯• H5
    vi.mocked(uni.getSystemInfoSync).mockReturnValue({
      platform: 'h5'
    } as any)
    expect(getBaseUrl()).toBe('/api')

    // æµ‹è¯•å°ç¨‹åº
    vi.mocked(uni.getSystemInfoSync).mockReturnValue({
      platform: 'weixin'
    } as any)
    expect(getBaseUrl()).toBe('https://your-domain.com/api')

    // æ¢å¤
    vi.mocked(uni.getSystemInfoSync).mockReturnValue({
      platform: originalPlatform
    } as any)
  })

  it('åº”è¯¥æ­£ç¡®å¤„ç†è¯·æ±‚é”™è¯¯', async () => {
    vi.mocked(uni.request).mockImplementation((options) => {
      options.fail?.({ errMsg: 'network error' } as any)
    })

    await expect(request({ url: '/test' })).rejects.toThrow()
  })
})
```

### å…«ã€éƒ¨ç½²é…ç½®

#### 8.1 H5 éƒ¨ç½²é…ç½®
```javascript
// frontend/vite.config.ts (ç”Ÿäº§ç¯å¢ƒä¼˜åŒ–)

import { defineConfig } from 'vite'
import uni from '@dcloudio/vite-plugin-uni'

export default defineConfig(({ mode }) => {
  const isProd = mode === 'production'

  return {
    plugins: [uni()],

    // ç”Ÿäº§ç¯å¢ƒä¼˜åŒ–
    build: {
      // ä»£ç åˆ†å‰²
      rollupOptions: {
        output: {
          manualChunks: {
            'vue-vendor': ['vue'],
            'uni-vendor': ['@dcloudio/uni-app'],
            'uview-vendor': ['uview-plus']
          }
        }
      },

      // Gzip å‹ç¼©
      reportCompressedSize: true,
      chunkSizeWarningLimit: 500
    },

    // ç”Ÿäº§ç¯å¢ƒä»£ç† (å¦‚æœæœ‰)
    server: isProd ? {} : {
      port: 8080,
      proxy: {
        '/api': {
          target: 'http://localhost:3000',
          changeOrigin: true,
          rewrite: (path) => path.replace(/^\/api/, '/api')
        }
      }
    }
  }
})
```

#### 8.2 Docker éƒ¨ç½²
```dockerfile
# frontend/Dockerfile

FROM node:18-alpine as builder

WORKDIR /app

# å¤åˆ¶ä¾èµ–
COPY package*.json ./
RUN npm ci

# å¤åˆ¶æºç 
COPY . .

# æ„å»º H5
RUN npm run build:h5

# Nginx éƒ¨ç½²
FROM nginx:alpine

# å¤åˆ¶æ„å»ºäº§ç‰©
COPY --from=builder /app/dist/h5 /usr/share/nginx/html

# å¤åˆ¶ Nginx é…ç½®
COPY nginx.conf /etc/nginx/nginx.conf

EXPOSE 80

CMD ["nginx", "-g", "daemon off;"]
```

```nginx
# frontend/nginx.conf

events {
    worker_connections 1024;
}

http {
    include /etc/nginx/mime.types;
    default_type application/octet-stream;

    # Gzip å‹ç¼©
    gzip on;
    gzip_vary on;
    gzip_min_length 1024;
    gzip_types text/plain text/css application/json application/javascript text/xml application/xml application/xml+rss text/javascript;

    server {
        listen 80;
        server_name your-domain.com;

        # SPA è·¯ç”±æ”¯æŒ
        location / {
            root /usr/share/nginx/html;
            try_files $uri $uri/ /index.html;
        }

        # API ä»£ç†
        location /api/ {
            proxy_pass http://backend:3000/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        }

        # é™æ€èµ„æºç¼“å­˜
        location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg)$ {
            expires 1y;
            add_header Cache-Control "public, immutable";
        }
    }
}
```

```yaml
# docker-compose.yml

version: '3.8'

services:
  frontend:
    build: ./frontend
    ports:
      - "80:80"
    depends_on:
      - backend
    restart: unless-stopped

  backend:
    build: ./backend
    ports:
      - "3000:3000"
    environment:
      - DATABASE_URL=postgresql://user:pass@db:5432/stardust
      - JWT_SECRET=your-secret-key
    depends_on:
      - db
      - redis
    restart: unless-stopped

  db:
    image: postgres:15
    environment:
      POSTGRES_DB: stardust
      POSTGRES_USER: user
      POSTGRES_PASSWORD: pass
    volumes:
      - postgres_data:/var/lib/postgresql/data
    restart: unless-stopped

  redis:
    image: redis:7-alpine
    volumes:
      - redis_data:/data
    restart: unless-stopped

volumes:
  postgres_data:
  redis_data:
```

---

## æ€»ç»“

è¿™å¥—å¤šç«¯é€‚é…æ–¹æ¡ˆæ¶µç›–äº†ï¼š

âœ… **é…ç½®ç®¡ç†**: ç»Ÿä¸€çš„å¤šç«¯é…ç½®
âœ… **æ ·å¼é€‚é…**: å“åº”å¼è®¾è®¡ + å¹³å°ç‰¹å®šæ ·å¼
âœ… **API é€‚é…**: ç»Ÿä¸€è¯·æ±‚ + å¹³å°ç‰¹å®šå¤„ç†
âœ… **ç»„ä»¶å¼€å‘**: å¯å¤ç”¨çš„å¤šç«¯ç»„ä»¶
âœ… **æ€§èƒ½ä¼˜åŒ–**: ç¼“å­˜ã€æ‡’åŠ è½½ã€å›¾ç‰‡ä¼˜åŒ–
âœ… **å¹³å°åŠŸèƒ½**: åˆ†äº«ã€æ”¯ä»˜ç­‰ç‰¹å®šåŠŸèƒ½
âœ… **è°ƒè¯•æµ‹è¯•**: å¤šç«¯è°ƒè¯•å·¥å…·
âœ… **éƒ¨ç½²æ–¹æ¡ˆ**: Docker + CI/CD

è¿™å¥—æ–¹æ¡ˆå¯ä»¥ç¡®ä¿æ‚¨çš„é¡¹ç›®åœ¨æ‰€æœ‰å¹³å°ä¸Šéƒ½èƒ½æä¾›ä¼˜ç§€çš„ç”¨æˆ·ä½“éªŒã€‚
