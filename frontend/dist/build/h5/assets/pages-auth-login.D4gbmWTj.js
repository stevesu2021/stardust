import{d as e,r as s,c as a,b as l,i as t,o as i,e as o,m as n,f as c,g as u,I as r,y as d,s as f,x as m,z as g,u as p}from"./index-VE_HmMG4.js";import{a as v,_}from"./_plugin-vue_export-helper.B_VXoL-J.js";import{u as w}from"./user.DucKNo_G.js";const h=_(e({__name:"login",setup(e){const _=s(""),h=s(""),x=s(!1),k=s(!1),y=w();async function C(){if(_.value&&_.value.trim())if(!h.value||h.value.length<6)f({title:"请输入正确密码",icon:"none"});else{x.value=!0;try{const e=await v.auth.login({identifier:_.value.trim(),password:h.value});y.setToken(e.token),y.setUserInfo(e.user),f({title:"登录成功",icon:"success"}),setTimeout(()=>{m({url:"/pages/index/index"})},1e3)}catch(e){console.error("登录错误:",e);let s="登录失败，请稍后重试";e.message?s=e.message:e.errMsg?s=e.errMsg:e.data&&e.data.message&&(s=e.data.message),f({title:s,icon:"none",duration:3e3})}finally{x.value=!1}}else f({title:"请输入手机号或邮箱",icon:"none"})}async function U(){k.value=!0;try{const e=await new Promise((e,s)=>{g({provider:"weixin",success:e,fail:s})}),s=await new Promise((e,s)=>{uni.getUserProfile({desc:"用于完善用户资料",success:e,fail:s})}),a=await v.auth.wechatLogin({code:e.code,userInfo:s.userInfo});y.setToken(a.token),y.setUserInfo(a.user),a.isNewUser?(f({title:"欢迎新用户！",icon:"success"}),setTimeout(()=>{p({url:"/pages/user/edit-profile"})},1500)):(f({title:"登录成功",icon:"success"}),setTimeout(()=>{m({url:"/pages/index/index"})},1e3))}catch(e){if(console.error("微信登录错误:",e),e.errMsg&&e.errMsg.includes("getUserProfile:fail"))f({title:"需要授权才能使用微信登录",icon:"none"});else{let s="微信登录失败";e.message?s=e.message:e.data&&e.data.message&&(s=e.data.message),f({title:s,icon:"none",duration:3e3})}}finally{k.value=!1}}function I(){p({url:"/pages/auth/register"})}return(e,s)=>{const f=n,m=c,g=t,p=r,v=d;return i(),a(g,{class:"container"},{default:l(()=>[o(g,{class:"wechat-section"},{default:l(()=>[o(g,{class:"wechat-login-btn",onClick:U},{default:l(()=>[o(f,{class:"wechat-icon",src:"data:image/svg+xml,%3csvg%20width='48'%20height='48'%20viewBox='0%200%2024%2024'%20fill='%2307C160'%20xmlns='http://www.w3.org/2000/svg'%3e%3cpath%20d='M12%202C6.48%202%202%206.48%202%2012c0%201.74.47%203.36%201.29%204.76L2%2022l5.24-1.29C8.64%2021.53%2010.26%2022%2012%2022c5.52%200%2010-4.48%2010-10S17.52%202%2012%202zm0%2018c-1.52%200-2.94-.38-4.21-1.05L6%2018l1.05-1.79C7.62%2015.47%208%2014.05%208%2012.5c0-3.03%202.47-5.5%205.5-5.5S19%209.47%2019%2012.5%2016.53%2018%2012%2018z'/%3e%3c/svg%3e",mode:"aspectFit"}),o(m,null,{default:l(()=>[u("微信登录")]),_:1})]),_:1}),o(g,{class:"divider"},{default:l(()=>[o(g,{class:"line"}),o(m,{class:"divider-text"},{default:l(()=>[u("或")]),_:1}),o(g,{class:"line"})]),_:1})]),_:1}),o(g,{class:"form"},{default:l(()=>[o(g,{class:"form-item"},{default:l(()=>[o(m,{class:"label"},{default:l(()=>[u("手机号/邮箱")]),_:1}),o(p,{class:"input",modelValue:_.value,"onUpdate:modelValue":s[0]||(s[0]=e=>_.value=e),placeholder:"请输入手机号或邮箱"},null,8,["modelValue"])]),_:1}),o(g,{class:"form-item"},{default:l(()=>[o(m,{class:"label"},{default:l(()=>[u("密码")]),_:1}),o(p,{class:"input",modelValue:h.value,"onUpdate:modelValue":s[1]||(s[1]=e=>h.value=e),type:"password",placeholder:"请输入密码"},null,8,["modelValue"])]),_:1}),o(v,{class:"btn",onClick:C,loading:x.value},{default:l(()=>[u("登录")]),_:1},8,["loading"]),o(g,{class:"links"},{default:l(()=>[o(m,{class:"link",onClick:I},{default:l(()=>[u("还没有账号？去注册")]),_:1})]),_:1})]),_:1})]),_:1})}}}),[["__scopeId","data-v-1518c2e5"]]);export{h as default};
